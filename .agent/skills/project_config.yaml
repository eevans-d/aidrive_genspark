project:
  name: "aidrive_genspark"
  environment: "hybrid (local/supabase)"

# === RUTAS CONCRETAS (sin templates) ===

paths:
  root: "."
  docs: "docs"
  backend_src: "supabase/functions"
  frontend_src: "minimarket-system/src"
  tests_root: "tests"
  migrations: "supabase/migrations"
  scripts: "scripts"
  agent_root: ".agent"
  env_example: ".env.example"
  openapi_spec: "docs/api-openapi-3.1.yaml"
  openapi_proveedor: "docs/api-proveedor-openapi-3.1.yaml"
  api_gateway: "supabase/functions/api-minimarket/index.ts"
  api_handlers: "supabase/functions/api-minimarket/handlers"

scripts:
  skills_sync: ".agent/scripts/sync_codex_skills.py"
  skills_lint: ".agent/scripts/lint_skills.py"
  skill_orchestrator: ".agent/scripts/skill_orchestrator.py"
  baseline_capture: ".agent/scripts/baseline_capture.sh"
  curated_skills_install: ".agent/scripts/install_curated_skills.py"
  bootstrap: ".agent/scripts/bootstrap.sh"
  quality_gates: ".agent/scripts/quality_gates.sh"
  session_start: ".agent/scripts/session_start.sh"
  session_end: ".agent/scripts/session_end.sh"
  kickoff: ".agent/scripts/kickoff.sh"
  mega_plan_template: ".agent/scripts/mega_plan_template.py"
  generate_agents_yaml: ".agent/scripts/generate_agents_yaml.py"
  env_audit: ".agent/scripts/env_audit.py"
  dependabot_autopilot: ".agent/scripts/dependabot_autopilot.sh"
  p0: ".agent/scripts/p0.sh"
  extract_reports: ".agent/scripts/extract_reports.py"
  test_unit: "npm run test:unit"
  test_all: "npm run test:all"
  test_coverage: "npm run test:coverage"
  test_integration: "npm run test:integration"
  test_e2e: "npm run test:e2e"
  test_security: "npm run test:security"
  build_frontend: "pnpm -C minimarket-system build"
  lint: "pnpm -C minimarket-system lint"
  deploy: "./deploy.sh"
  migrate: "supabase db push"
  functions_deploy: "supabase functions deploy"

policies:
  retry_max: 2
  timeout_seconds: 300
  max_session_hours: 4
  coverage_min: 80
  allowed_branches:
    - "main"
    - "staging"
  forbidden_patterns:
    - "console.log"
    - "ey[A-Za-z0-9-_=]{20,}"

outputs:
  test_report: "test-reports/test-summary.json"
  deploy_log: "logs/deployment-*.json"
  reality_check_report: "docs/REALITY_CHECK_UX.md"
  performance_report: "docs/PERFORMANCE_REPORT.md"
  session_report: ".agent/sessions/current/SESSION_REPORT.md"
  evidence: ".agent/sessions/current/EVIDENCE.md"
  required_dirs:
    - "logs"
    - "test-reports"
    - ".agent/sessions/current"
    - ".agent/sessions/archive"

# === PROTOCOL ZERO V4.0: Sistema Agentico Dual ===

reality_rules:
  R0_reality: "No afirmar como hecho algo no verificable en el repo. Clasificar: REAL / A CREAR / PROPUESTA FUTURA"
  R1_source_of_truth: "La verdad operativa vive en filesystem, no en chat"
  R2_evidence: "Cada cambio relevante debe dejar rastro (que, por que, archivos, validacion)"
  R3_risk: "Acciones con impacto >= Nivel 2 requieren rollback explicito"

impact_levels:
  0: "Observacion - no cambia nada"
  1: "Optimizacion transparente - riesgo minimo"
  2: "Impacto controlado - requiere rollback claro"
  3: "Critico de negocio - requiere aprobacion humana"

session_config:
  sessions_dir: ".agent/sessions"
  archive_completed: true
  require_evidence: true
  max_session_hours: 4

# === ROLES DUALES ===

roles:
  CODEX:
    identity: "Arquitecto + PM + Auditor. Estado FRIO."
    behavior: |
      - Produce: briefing, checklist, restricciones, validaciones, consolidacion documental.
      - NO hace implementacion profunda.
      - Genera planes, no codigo final.
    activates_when:
      - "No existe SESSION_ACTIVE en .agent/sessions/current/"
      - "Se completo una sesion (existe SESSION_COMPLETE)"
      - "Usuario pide planificar, auditar o revisar"
    output_artifacts:
      - "BRIEFING.md"
      - "POST_SESSION_REVIEW.md"
      - "SESSION_REPORT.md"

  EXECUTOR:
    identity: "Ejecutor tactico. Estado CALIENTE."
    behavior: |
      - Ejecuta paso-a-paso con tracking riguroso.
      - MINIMA charla, MAXIMA ejecucion.
      - Si hay bloqueo real: registra y pide transicion.
    activates_when:
      - "Existe SESSION_ACTIVE en .agent/sessions/current/"
      - "El briefing esta listo y aprobado"
    output_artifacts:
      - "EVIDENCE.md"
      - "FILES_CHANGED.md"
      - "SESSION_LOG.md"

auto_detection:
  description: "El agente detecta automaticamente que rol asumir"
  check_order:
    - "ls .agent/sessions/current/SESSION_ACTIVE"
    - "Si existe -> EXECUTOR | Si no existe -> CODEX"
  fallback: "CODEX"

kernel:
  description: "Comportamiento core del agente"
  rules:
    - "Antes de responder, verificar estado de SESSION_ACTIVE"
    - "Si no existe .agent/sessions/, actuar como CODEX y crear infraestructura"
    - "EXECUTOR ignora debate: ejecuta checklist + deja evidencia"
    - "CODEX no hace deep implementation: produce plan, valida, consolida"
    - "Toda afirmacion REAL debe tener evidencia (ruta, comando, screenshot)"
    - "Toda afirmacion A CREAR debe indicar por que se necesita"
    - "Toda PROPUESTA FUTURA es opcional y no bloquea"

# === SKILL ORCHESTRATOR: Auto-Seleccion sin Intervencion Manual ===

skill_orchestrator:
  enabled: true
  auto_select: true
  default_skill: "RealityCheck"

  trigger_patterns:
    BaselineOps:
      keywords: ["baseline", "baseline inmediato", "estado del repo", "estado del repositorio", "snapshot", "captura baseline", "baseline log", "git status", "supabase functions list", "supabase secrets list"]
      intent: "Capturar baseline seguro y evidencia operativa"
    SessionOps:
      keywords: ["nueva sesion", "nueva sesión", "arranquemos", "kickoff", "empezar", "iniciar sesion", "iniciar sesión", "session start", "session end", "session-end", "cerrar sesion", "cerrar sesión", "cierre de sesion", "cierre de sesión", "archivar sesion", "archivar sesión"]
      intent: "Arranque/cierre de sesion con evidencia (push-button)"
    ExtractionOps:
      keywords: ["analisis tecnico completo", "análisis técnico completo", "reconocimiento completo", "extraccion de informacion", "extracción de información", "inventario de recursos", "inventory report", "technical analysis", "production readiness report"]
      intent: "Extraccion completa (analisis tecnico + inventario) para planificar produccion"
    CodeCraft:
      keywords: ["crea endpoint", "agrega pantalla", "implementa feature", "nueva funcion", "nuevo componente", "crea la pagina", "agrega el endpoint", "crea la funcionalidad"]
      intent: "Crear codigo nuevo"
    DependabotOps:
      keywords: ["dependabot", "renovate", "actualiza dependencias", "update dependencies", "deps", "merge dependabot", "pr dependabot", "pull request", "package-lock", "pnpm-lock", "lockfile"]
      intent: "Revisar y mergear PRs de dependencias"
    SendGridOps:
      keywords: ["sendgrid", "smtp", "smtp_from", "email_from", "notificaciones email", "from email", "sender", "verified sender"]
      intent: "Verificar/corregir configuracion SendGrid/SMTP"
    SecretRotationOps:
      keywords: ["rotacion de secretos", "rotar secretos", "secret rotation", "rotate secrets", "api_proveedor_secret", "sendgrid_api_key", "smtp_pass", "service_role_key", "anon_key"]
      intent: "Rotacion segura de secretos con rollback"
    SentryOps:
      keywords: ["sentry", "dsn", "observability", "observabilidad", "error tracking", "captureException"]
      intent: "Integracion Sentry UI (solo con DSN real)"
    EnvAuditOps:
      keywords: ["env", "dotenv", "variables de entorno", "environment variables", "env audit", "drift", "faltan variables", "missing env var"]
      intent: "Auditar drift de env vars (codigo vs docs vs secrets)"
    MegaPlanner:
      keywords: ["mega plan", "hoja de ruta", "roadmap", "planificacion", "planificación", "prioridades", "next steps", "plan de ejecucion", "plan de ejecución"]
      intent: "Planificacion superior y priorizacion"
    TestMaster:
      keywords: ["ejecuta tests", "corre pruebas", "verifica tests", "run tests", "test suite", "coverage"]
      intent: "Ejecutar pruebas"
    RealityCheck:
      keywords: ["audita", "verifica ux", "revisa usabilidad", "analiza", "reality check", "valida flujo", "revisa produccion"]
      intent: "Auditar sistema"
    DeployOps:
      keywords: ["deploy", "despliega", "sube a staging", "sube a prod", "publica", "release"]
      intent: "Desplegar a un entorno"
    DocuGuard:
      keywords: ["actualiza docs", "sincroniza documentacion", "documenta", "update docs", "revisa docs"]
      intent: "Mantener documentacion"
    MigrationOps:
      keywords: ["aplica migracion", "crear tabla", "modificar esquema", "migrar", "db push", "supabase db", "migration", "nueva columna"]
      intent: "Gestionar migraciones SQL"
    DebugHound:
      keywords: ["debug", "error", "falla", "bug", "arregla", "fix", "broken", "crash", "exception", "no funciona"]
      intent: "Resolver errores y bugs"
    PerformanceWatch:
      keywords: ["performance", "rendimiento", "lento", "optimizar", "bundle size", "slow", "mejorar velocidad"]
      intent: "Analizar y optimizar rendimiento"
    APISync:
      keywords: ["openapi", "swagger", "api spec", "documentar api", "sincronizar api", "api docs"]
      intent: "Sincronizar OpenAPI spec"
    SecurityAudit:
      keywords: ["seguridad", "security", "rls", "vulnerabilidad", "auditoria seguridad", "penetration", "xss", "injection"]
      intent: "Auditar seguridad del sistema"

# === SKILL GRAPH: Dependencias y Cadenas Automaticas ===

skill_graph:
  chains:
    BaselineOps:
      on_complete: []
      description: "Baseline es terminal: produce evidencia y no dispara ejecucion"
    SessionOps:
      on_complete: [ExtractionOps, MegaPlanner]
      description: "Arranque/cierre de sesion; tras kickoff, extraer evidencia y planificar"
    ExtractionOps:
      on_complete: [MegaPlanner]
      description: "Despues de extraer info: planificar (Top-10) basado en evidencia"
    CodeCraft:
      on_complete: [TestMaster, DocuGuard, MigrationOps]
      description: "Despues de implementar: probar, documentar, y migrar si hay tablas nuevas"
    DependabotOps:
      on_complete: [TestMaster, DocuGuard]
      description: "Despues de actualizar deps: correr gates y documentar evidencia"
    SendGridOps:
      on_complete: [DocuGuard]
      description: "Despues de corregir config SMTP/SendGrid: documentar evidencia"
    SecretRotationOps:
      on_complete: [DocuGuard]
      description: "Despues de rotar secretos: documentar evidencia y actualizar inventario"
    SentryOps:
      on_complete: [TestMaster, PerformanceWatch, DocuGuard]
      description: "Despues de integrar Sentry: gates + perf + docs"
    EnvAuditOps:
      on_complete: [DocuGuard]
      description: "Despues de auditar env: actualizar docs/inventario si aplica"
    MegaPlanner:
      on_complete: [DocuGuard]
      description: "Despues de planificar: consolidar evidencia/doc (si aplica)"
    TestMaster:
      on_complete: []
      description: "Tests son terminales, no disparan otros skills"
    DeployOps:
      pre_check: [TestMaster]
      on_complete: [RealityCheck]
      description: "Antes de deploy verificar tests, despues smoke test"
    RealityCheck:
      on_complete: [DocuGuard]
      description: "Despues de auditar, sincronizar docs"
    DocuGuard:
      on_complete: []
      description: "Documentacion es terminal"
    MigrationOps:
      on_complete: [DocuGuard]
      description: "Despues de migrar, actualizar docs de esquema"
    DebugHound:
      on_complete: [TestMaster]
      description: "Despues de fix, verificar que tests pasen"
    PerformanceWatch:
      on_complete: [DocuGuard]
      description: "Despues de analisis, documentar metricas"
    APISync:
      on_complete: [DocuGuard]
      description: "Despues de sync, actualizar changelog"
    SecurityAudit:
      on_complete: [DocuGuard]
      description: "Despues de auditoria, documentar hallazgos"

  dependencies:
    DeployOps:
      requires:
        - skill: TestMaster
          condition: "exit_code == 0"
          message: "Tests deben pasar antes de deploy"
    MigrationOps:
      requires:
        - skill: TestMaster
          condition: "exit_code == 0"
          message: "Tests deben pasar antes de migrar a produccion"

# === FALLBACK BEHAVIOR: Nunca Esperar Input ===

fallback_behavior:
  on_uncertainty:
    - "Usar valor/ubicacion por defecto"
    - "Documentar decision en EVIDENCE.md"
    - "Continuar ejecucion SIN esperar input"
    - "Reportar en SESSION_REPORT.md"
  on_error:
    - "Documentar error con stack trace"
    - "Intentar recovery automatico (max 2 reintentos)"
    - "Si falla: cerrar sesion como PARCIAL"
    - "Generar reporte con recomendaciones"
  never_do:
    - "Esperar input manual si impacto <= 1"
    - "Quedarse en loop sin accion"
    - "Preguntar si no es estrictamente necesario"
    - "Afirmar REAL sin evidencia de filesystem"
