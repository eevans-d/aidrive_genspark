openapi: 3.1.0
info:
  title: Mini Market API - Sistema Completo de Gestión
  version: 1.0.0
  description: |
    API RESTful completa para el sistema de gestión de Mini Market y Depósito.
    
    ## Autenticación
    La API utiliza JWT (JSON Web Tokens) mediante Supabase Auth.
    
    ## Roles de Usuario
    - **admin**: Acceso completo a todas las operaciones
    - **deposito**: Gestión de inventario y productos
    - **ventas**: Solo lectura de productos y stock
    
    ## Sistema de Redondeo de Precios
    Todos los precios se redondean automáticamente a múltiplos de 50:
    - 2345 → 2350
    - 8627 → 8650
    - 12384 → 12400

    ## Nota de cobertura
    Este spec documenta el gateway `api-minimarket`. Para ejemplos prácticos, notas operativas
    (CORS, idempotencia, errores esperados) y smoke tests, ver `docs/API_README.md`.

    ## Edge Functions adicionales (fuera de este spec)
    - `api-assistant`: asistente IA conversacional (Sprint 1, read-only, admin-only). POST /message.
    - `api-proveedor`: integracion con proveedor externo. Ver `docs/api-proveedor-openapi-3.1.yaml`.
    - `facturas-ocr`: extraccion OCR de facturas (llamada server-to-server desde api-minimarket).

  contact:
    name: Soporte Mini Market
    email: soporte@minimarket.com
  license:
    name: Propietario

servers:
  - url: https://dqaygmjpzoqjjrywdsxi.supabase.co/functions/v1/api-minimarket
    description: Servidor de Producción

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT de Supabase Auth
  
  schemas:
    Categoria:
      type: object
      properties:
        id:
          type: string
          format: uuid
        codigo:
          type: string
          example: "SAL"
        nombre:
          type: string
          example: "Salchichas"
        descripcion:
          type: string
        margen_minimo:
          type: number
          format: decimal
        margen_maximo:
          type: number
          format: decimal
        activo:
          type: boolean
    
    Producto:
      type: object
      properties:
        id:
          type: string
          format: uuid
        sku:
          type: string
          example: "FELA-SAL-X6"
        nombre:
          type: string
          example: "Salchichas FELA x6"
        marca:
          type: string
          example: "FELA"
        contenido_neto:
          type: string
          example: "240g"
        categoria_id:
          type: string
          format: uuid
        activo:
          type: boolean
        precio_actual:
          type: number
          format: decimal
        precio_costo:
          type: number
          format: decimal
        margen_ganancia:
          type: number
          format: decimal
    
    Proveedor:
      type: object
      properties:
        id:
          type: string
          format: uuid
        nombre:
          type: string
          example: "Maxiconsumo Necochea"
        contacto:
          type: string
        email:
          type: string
          format: email
        telefono:
          type: string
        productos_ofrecidos:
          type: string
        activo:
          type: boolean
    
    Stock:
      type: object
      properties:
        id:
          type: string
          format: uuid
        producto_id:
          type: string
          format: uuid
        cantidad_fisica:
          type: integer
        cantidad_reservada:
          type: integer
        cantidad_disponible:
          type: integer
        stock_minimo:
          type: integer
        stock_maximo:
          type: integer
        producto:
          $ref: '#/components/schemas/Producto'
    
    Movimiento:
      type: object
      properties:
        id:
          type: string
          format: uuid
        producto_id:
          type: string
          format: uuid
        tipo_movimiento:
          type: string
          enum: [INGRESO, EGRESO, AJUSTE, DEVOLUCION]
        cantidad:
          type: integer
        motivo:
          type: string
        fecha_movimiento:
          type: string
          format: date-time
        usuario_id:
          type: string
          format: uuid

    EfectividadTareasUsuario:
      type: object
      properties:
        usuario_id:
          type: string
          format: uuid
          nullable: true
        tareas_total:
          type: integer
        tareas_completadas:
          type: integer
        tiempo_resolucion_promedio_horas:
          type: number
          format: float
          nullable: true
        dias_atraso_promedio:
          type: number
          format: float
          nullable: true
        cumplimiento_sla_pct:
          type: number
          format: float
          nullable: true
        sla_cumplidas:
          type: integer
        sla_incumplidas:
          type: integer
    
    # ============================================================================
    # SCHEMAS DE PEDIDOS (NUEVO)
    # ============================================================================
    
    Cliente:
      type: object
      properties:
        id:
          type: string
          format: uuid
        nombre:
          type: string
          example: "Juan Pérez"
        telefono:
          type: string
          example: "+54 9 2262 123456"
        email:
          type: string
          format: email
        direccion_default:
          type: string
        notas:
          type: string
        activo:
          type: boolean
    
    DetallePedido:
      type: object
      properties:
        id:
          type: string
          format: uuid
        pedido_id:
          type: string
          format: uuid
        producto_id:
          type: string
          format: uuid
          nullable: true
        producto_nombre:
          type: string
          example: "Salchichas FELA x6"
        producto_sku:
          type: string
          nullable: true
        cantidad:
          type: integer
          minimum: 1
        precio_unitario:
          type: number
          format: decimal
        subtotal:
          type: number
          format: decimal
        observaciones:
          type: string
          nullable: true
        preparado:
          type: boolean
          default: false
        preparado_por_id:
          type: string
          format: uuid
          nullable: true
        fecha_preparado:
          type: string
          format: date-time
          nullable: true
    
    Pedido:
      type: object
      properties:
        id:
          type: string
          format: uuid
        numero_pedido:
          type: integer
          example: 1234
        cliente_id:
          type: string
          format: uuid
          nullable: true
        cliente_nombre:
          type: string
          example: "Juan Pérez"
        cliente_telefono:
          type: string
          nullable: true
        estado:
          type: string
          enum: [pendiente, preparando, listo, entregado, cancelado]
          example: "pendiente"
        tipo_entrega:
          type: string
          enum: [retiro, domicilio]
          example: "domicilio"
        direccion_entrega:
          type: string
          nullable: true
        edificio:
          type: string
          nullable: true
        piso:
          type: string
          nullable: true
        departamento:
          type: string
          nullable: true
        horario_entrega_preferido:
          type: string
          nullable: true
        monto_total:
          type: number
          format: decimal
        monto_pagado:
          type: number
          format: decimal
          default: 0
        estado_pago:
          type: string
          enum: [pendiente, parcial, pagado]
          example: "pendiente"
        observaciones:
          type: string
          nullable: true
        fecha_pedido:
          type: string
          format: date-time
        fecha_preparado:
          type: string
          format: date-time
          nullable: true
        fecha_entregado:
          type: string
          format: date-time
          nullable: true
        detalle_pedidos:
          type: array
          items:
            $ref: '#/components/schemas/DetallePedido'
    
    CrearPedidoRequest:
      type: object
      required:
        - cliente_nombre
        - tipo_entrega
        - items
      properties:
        cliente_nombre:
          type: string
          example: "Juan Pérez"
        cliente_telefono:
          type: string
          example: "+54 9 2262 123456"
        cliente_id:
          type: string
          format: uuid
          description: "ID de cliente existente (opcional)"
        tipo_entrega:
          type: string
          enum: [retiro, domicilio]
        direccion_entrega:
          type: string
          description: "Requerido si tipo_entrega=domicilio"
        edificio:
          type: string
        piso:
          type: string
        departamento:
          type: string
        horario_entrega_preferido:
          type: string
        observaciones:
          type: string
        items:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - producto_nombre
              - cantidad
              - precio_unitario
            properties:
              producto_id:
                type: string
                format: uuid
              producto_nombre:
                type: string
              producto_sku:
                type: string
              cantidad:
                type: integer
                minimum: 1
              precio_unitario:
                type: number
                format: decimal
              observaciones:
                type: string

    # ============================================================================
    # SCHEMAS — SEARCH / INSIGHTS / POS / CLIENTES / OFERTAS / BITÁCORA (NUEVO)
    # ============================================================================

    SearchProducto:
      type: object
      properties:
        id: { type: string, format: uuid }
        sku: { type: string, nullable: true }
        nombre: { type: string }
        marca: { type: string, nullable: true }
        precio_actual: { type: number, format: decimal, nullable: true }
        codigo_barras: { type: string, nullable: true }
        activo: { type: boolean }

    SearchProveedor:
      type: object
      properties:
        id: { type: string, format: uuid }
        nombre: { type: string }
        contacto: { type: string, nullable: true }
        email: { type: string, format: email, nullable: true }
        telefono: { type: string, nullable: true }

    SearchTarea:
      type: object
      properties:
        id: { type: string, format: uuid }
        titulo: { type: string }
        estado: { type: string }
        prioridad: { type: string }
        asignada_a_nombre: { type: string, nullable: true }
        fecha_vencimiento: { type: string, format: date-time, nullable: true }

    SearchPedido:
      type: object
      properties:
        id: { type: string, format: uuid }
        numero_pedido: { type: integer }
        cliente_nombre: { type: string }
        cliente_telefono: { type: string, nullable: true }
        estado: { type: string }
        estado_pago: { type: string }
        monto_total: { type: number, format: decimal }
        fecha_pedido: { type: string, format: date-time }

    SearchCliente:
      type: object
      properties:
        id: { type: string, format: uuid }
        nombre: { type: string }
        telefono: { type: string, nullable: true }
        email: { type: string, format: email, nullable: true }
        direccion_default: { type: string, nullable: true }

    SearchResponse:
      type: object
      properties:
        productos:
          type: array
          items: { $ref: '#/components/schemas/SearchProducto' }
        proveedores:
          type: array
          items: { $ref: '#/components/schemas/SearchProveedor' }
        tareas:
          type: array
          items: { $ref: '#/components/schemas/SearchTarea' }
        pedidos:
          type: array
          items: { $ref: '#/components/schemas/SearchPedido' }
        clientes:
          type: array
          items: { $ref: '#/components/schemas/SearchCliente' }

    InsightArbitrajeItem:
      type: object
      properties:
        producto_id: { type: string, format: uuid }
        nombre_producto: { type: string }
        sku: { type: string, nullable: true }
        costo_proveedor_actual: { type: number, format: decimal }
        costo_proveedor_prev: { type: number, format: decimal, nullable: true }
        delta_costo_pct: { type: number, format: decimal, nullable: true }
        precio_venta_actual: { type: number, format: decimal, nullable: true }
        margen_vs_reposicion: { type: number, format: decimal, nullable: true }
        riesgo_perdida: { type: boolean }
        margen_bajo: { type: boolean }
        fecha_ultima_comparacion: { type: string, format: date-time }

    InsightCompraItem:
      allOf:
        - $ref: '#/components/schemas/InsightArbitrajeItem'
        - type: object
          properties:
            cantidad_actual: { type: integer }
            stock_minimo: { type: integer }
            nivel_stock: { type: string }

    ClienteSaldoItem:
      type: object
      properties:
        cliente_id: { type: string, format: uuid }
        nombre: { type: string }
        telefono: { type: string, nullable: true }
        email: { type: string, format: email, nullable: true }
        direccion_default: { type: string, nullable: true }
        whatsapp_e164: { type: string, nullable: true }
        link_pago: { type: string, nullable: true }
        limite_credito: { type: number, format: decimal, nullable: true }
        saldo: { type: number, format: decimal }
        ultimo_movimiento: { type: string, format: date-time, nullable: true }

    ClienteCreateRequest:
      type: object
      required: [nombre]
      properties:
        nombre: { type: string }
        telefono: { type: string, nullable: true }
        email: { type: string, format: email, nullable: true }
        direccion_default: { type: string, nullable: true }
        edificio: { type: string, nullable: true }
        piso: { type: string, nullable: true }
        departamento: { type: string, nullable: true }
        observaciones: { type: string, nullable: true }
        whatsapp_e164: { type: string, nullable: true }
        link_pago: { type: string, nullable: true }
        limite_credito: { type: number, format: decimal, nullable: true, description: "Solo admin" }
        activo: { type: boolean, default: true }

    ClienteUpdateRequest:
      type: object
      properties:
        nombre: { type: string }
        telefono: { type: string, nullable: true }
        email: { type: string, format: email, nullable: true }
        direccion_default: { type: string, nullable: true }
        edificio: { type: string, nullable: true }
        piso: { type: string, nullable: true }
        departamento: { type: string, nullable: true }
        observaciones: { type: string, nullable: true }
        whatsapp_e164: { type: string, nullable: true }
        link_pago: { type: string, nullable: true }
        limite_credito: { type: number, format: decimal, nullable: true, description: "Solo admin" }
        activo: { type: boolean }

    CuentaCorrienteResumen:
      type: object
      properties:
        dinero_en_la_calle: { type: number, format: decimal }
        clientes_con_deuda: { type: integer }
        as_of: { type: string, format: date-time }

    RegistrarPagoCCRequest:
      type: object
      required: [cliente_id, monto]
      properties:
        cliente_id: { type: string, format: uuid }
        monto: { type: number, format: decimal, description: "Monto > 0 (se registra como pago negativo en ledger)" }
        descripcion: { type: string, nullable: true }

    RegistrarPagoCCResponse:
      type: object
      properties:
        cliente_id: { type: string, format: uuid }
        saldo: { type: number, format: decimal }

    VentaItemInput:
      type: object
      required: [producto_id, cantidad]
      properties:
        producto_id: { type: string, format: uuid }
        cantidad: { type: integer, minimum: 1 }

    VentaCreateRequest:
      type: object
      required: [metodo_pago, items]
      properties:
        metodo_pago: { type: string, enum: [efectivo, tarjeta, cuenta_corriente] }
        cliente_id: { type: string, format: uuid, nullable: true }
        confirmar_riesgo: { type: boolean, default: false }
        items:
          type: array
          minItems: 1
          items: { $ref: '#/components/schemas/VentaItemInput' }

    VentaItemRow:
      type: object
      properties:
        id: { type: string, format: uuid }
        producto_id: { type: string, format: uuid }
        producto_nombre: { type: string }
        producto_sku: { type: string, nullable: true }
        cantidad: { type: integer }
        precio_unitario: { type: number, format: decimal }
        subtotal: { type: number, format: decimal }

    VentaResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        idempotency_key: { type: string }
        metodo_pago: { type: string }
        cliente_id: { type: string, format: uuid, nullable: true }
        monto_total: { type: number, format: decimal }
        created_at: { type: string, format: date-time }
        status: { type: string, enum: [created, existing] }
        items:
          type: array
          items: { $ref: '#/components/schemas/VentaItemRow' }

    OfertaSugeridaItem:
      type: object
      properties:
        stock_id: { type: string, format: uuid }
        producto_id: { type: string, format: uuid }
        producto_nombre: { type: string }
        sku: { type: string, nullable: true }
        codigo_barras: { type: string, nullable: true }
        ubicacion: { type: string, nullable: true }
        fecha_vencimiento: { type: string, format: date, nullable: true }
        dias_hasta_vencimiento: { type: integer }
        cantidad_actual: { type: integer }
        descuento_sugerido_pct: { type: number, format: decimal }
        precio_base: { type: number, format: decimal }
        precio_oferta_sugerido: { type: number, format: decimal }
        as_of: { type: string, format: date-time }

    OfertaAplicarRequest:
      type: object
      required: [stock_id]
      properties:
        stock_id: { type: string, format: uuid }
        descuento_pct: { type: number, format: decimal, nullable: true, description: "Default 30 si no se envía" }

    BitacoraCreateRequest:
      type: object
      required: [nota]
      properties:
        nota: { type: string, maxLength: 2000 }
        usuario_nombre: { type: string, nullable: true }

    BitacoraItem:
      type: object
      properties:
        id: { type: string, format: uuid }
        usuario_nombre: { type: string, nullable: true }
        usuario_email: { type: string, format: email, nullable: true }
        usuario_rol: { type: string, nullable: true }
        nota: { type: string }
        created_at: { type: string, format: date-time }
    
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
        timestamp:
          type: string
          format: date-time
    
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
        message:
          type: string
        count:
          type: integer
        timestamp:
          type: string
          format: date-time

paths:
  /categorias:
    get:
      summary: Listar todas las categorías
      tags: [Categorías]
      security: []
      responses:
        '200':
          description: Lista de categorías activas
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Categoria'
  
  /categorias/{id}:
    get:
      summary: Obtener detalle de categoría
      tags: [Categorías]
      security: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Detalle de la categoría
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Categoria'
        '404':
          description: Categoría no encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /productos:
    get:
      summary: Listar productos con filtros opcionales
      tags: [Productos]
      security: []
      parameters:
        - name: categoria
          in: query
          schema:
            type: string
          description: Código de categoría (ej. SAL, QUE)
        - name: marca
          in: query
          schema:
            type: string
          description: Filtrar por marca
        - name: activo
          in: query
          schema:
            type: boolean
          description: Filtrar por estado activo
        - name: search
          in: query
          schema:
            type: string
          description: Búsqueda por nombre o SKU
      responses:
        '200':
          description: Lista de productos
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Producto'
    
    post:
      summary: Crear nuevo producto
      tags: [Productos]
      security:
        - BearerAuth: []
      description: Requiere rol admin o deposito
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [nombre]
              properties:
                sku:
                  type: string
                nombre:
                  type: string
                categoria_id:
                  type: string
                  format: uuid
                marca:
                  type: string
                contenido_neto:
                  type: string
      responses:
        '201':
          description: Producto creado exitosamente
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Producto'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Acceso denegado - rol insuficiente
  
  /productos/{id}:
    get:
      summary: Obtener detalle de producto
      tags: [Productos]
      security: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Detalle del producto
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Producto'
        '404':
          description: Producto no encontrado
    
    put:
      summary: Actualizar producto
      tags: [Productos]
      security:
        - BearerAuth: []
      description: Requiere rol admin o deposito
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Producto'
      responses:
        '200':
          description: Producto actualizado
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Producto'
    
    delete:
      summary: Eliminar producto (soft delete)
      tags: [Productos]
      security:
        - BearerAuth: []
      description: Requiere rol admin
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Producto desactivado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
  
  /proveedores:
    get:
      summary: Listar proveedores activos
      tags: [Proveedores]
      security: []
      responses:
        '200':
          description: Lista de proveedores
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Proveedor'
  
  /proveedores/{id}:
    get:
      summary: Obtener detalle de proveedor
      tags: [Proveedores]
      security: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Detalle del proveedor
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Proveedor'
  
  /precios/aplicar:
    post:
      summary: Aplicar precio a producto con redondeo automático
      tags: [Precios]
      security:
        - BearerAuth: []
      description: |
        Requiere rol admin. 
        Aplica precio de compra al producto, calcula precio de venta con margen y redondea automáticamente a múltiplos de 50.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [producto_id, precio_compra]
              properties:
                producto_id:
                  type: string
                  format: uuid
                precio_compra:
                  type: number
                  format: decimal
                margen_ganancia:
                  type: number
                  format: decimal
                  description: Margen opcional (si no se especifica, usa el de la categoría)
      responses:
        '200':
          description: Precio aplicado y redondeado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
  
  /precios/producto/{id}:
    get:
      summary: Historial de precios de un producto
      tags: [Precios]
      security: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID del producto
      responses:
        '200':
          description: Historial de cambios de precio
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          type: object
                          properties:
                            precio_anterior:
                              type: number
                            precio_nuevo:
                              type: number
                            fecha_cambio:
                              type: string
                              format: date-time
                            motivo_cambio:
                              type: string
  
  /precios/redondear:
    post:
      summary: Redondear un precio (función de utilidad)
      tags: [Precios]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [precio]
              properties:
                precio:
                  type: number
                  format: decimal
      responses:
        '200':
          description: Precio redondeado
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          precio_original:
                            type: number
                          precio_redondeado:
                            type: number
  
  /precios/margen-sugerido/{id}:
    get:
      summary: Calcular margen sugerido para producto
      tags: [Precios]
      security: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID del producto
      responses:
        '200':
          description: Margen sugerido calculado
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          producto_id:
                            type: string
                            format: uuid
                          margen_sugerido:
                            type: number

  /reportes/efectividad-tareas:
    get:
      summary: Reporte de efectividad de tareas por usuario
      tags: [Reportes]
      security:
        - BearerAuth: []
      parameters:
        - name: usuario_id
          in: query
          schema:
            type: string
            format: uuid
          description: Filtrar por usuario asignado
        - name: fecha_desde
          in: query
          schema:
            type: string
            format: date-time
          description: Fecha mínima de completado (ISO 8601)
        - name: fecha_hasta
          in: query
          schema:
            type: string
            format: date-time
          description: Fecha máxima de completado (ISO 8601)
      responses:
        '200':
          description: Agregados de efectividad por usuario
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/EfectividadTareasUsuario'
  
  /stock:
    get:
      summary: Consultar stock general de todos los productos
      tags: [Stock]
      security: []
      responses:
        '200':
          description: Stock de todos los productos
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Stock'
  
  /stock/minimo:
    get:
      summary: Productos con stock bajo mínimo
      tags: [Stock]
      security: []
      responses:
        '200':
          description: Lista de productos con stock crítico
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          type: object
                          properties:
                            producto_id:
                              type: string
                            sku:
                              type: string
                            nombre:
                              type: string
                            stock_actual:
                              type: integer
                            stock_minimo:
                              type: integer
                            deficit:
                              type: integer
  
  /stock/producto/{id}:
    get:
      summary: Stock específico de un producto
      tags: [Stock]
      security: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID del producto
      responses:
        '200':
          description: Stock del producto
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          producto_id:
                            type: string
                          stock_disponible:
                            type: integer
                          detalle:
                            $ref: '#/components/schemas/Stock'
  
  /deposito/movimiento:
    post:
      summary: Registrar movimiento de inventario
      tags: [Depósito]
      security:
        - BearerAuth: []
      description: Requiere rol admin o deposito
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              anyOf:
                - required: [producto_id, tipo, cantidad]
                - required: [producto_id, tipo_movimiento, cantidad]
              properties:
                producto_id:
                  type: string
                  format: uuid
                tipo:
                  type: string
                  enum: [entrada, salida, ajuste, transferencia]
                tipo_movimiento:
                  type: string
                  enum: [entrada, salida, ajuste, transferencia]
                  deprecated: true
                cantidad:
                  type: integer
                origen:
                  type: string
                destino:
                  type: string
                motivo:
                  type: string
                proveedor_id:
                  type: string
                  format: uuid
                observaciones:
                  type: string
      responses:
        '201':
          description: Movimiento registrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
  
  /deposito/movimientos:
    get:
      summary: Historial de movimientos de depósito
      tags: [Depósito]
      security: []
      parameters:
        - name: producto_id
          in: query
          schema:
            type: string
            format: uuid
        - name: tipo_movimiento
          in: query
          schema:
            type: string
            enum: [entrada, salida, ajuste, transferencia]
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Lista de movimientos
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Movimiento'
  
  /deposito/ingreso:
    post:
      summary: Ingreso de mercadería al depósito
      tags: [Depósito]
      security:
        - BearerAuth: []
      description: Requiere rol admin o deposito
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [producto_id, cantidad]
              properties:
                producto_id:
                  type: string
                  format: uuid
                cantidad:
                  type: integer
                proveedor_id:
                  type: string
                  format: uuid
                precio_compra:
                  type: number
                  format: decimal
      responses:
        '201':
          description: Ingreso registrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  /compras/recepcion:
    post:
      summary: Registrar recepción de orden de compra
      tags: [Compras]
      security:
        - BearerAuth: []
      description: |
        Registra la recepción de una orden de compra. Requiere rol admin o deposito.

        Crea un movimiento de entrada atómico en el inventario. Valida que la cantidad
        no exceda lo pendiente de recepción (mediante stored procedure sp_movimiento_inventario).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [orden_compra_id, cantidad]
              properties:
                orden_compra_id:
                  type: string
                  format: uuid
                cantidad:
                  type: integer
                  minimum: 1
                deposito:
                  type: string
                  default: Principal
      responses:
        '201':
          description: Recepción registrada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Validación fallida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Orden de compra no encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Cantidad supera lo pendiente de recepción
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /facturas/{id}/extraer:
    post:
      summary: Invocar extracción OCR de factura
      tags: [Facturas]
      security:
        - BearerAuth: []
      description: |
        Invoca la extracción OCR de una factura. Gateway hacia Edge Function `facturas-ocr`.

        - Descarga imagen desde bucket Storage
        - Envía a Google Cloud Vision API
        - Parsea texto y ejecuta matching de productos (barcode/SKU → alias → fuzzy name)
        - Crea items extraídos para validación posterior

        Runtime actual:
        - Requiere rol admin/deposito
        - El gateway valida estado `pendiente|error` antes de invocar OCR
        - Si la factura no está en `pendiente|error`, responde `409 INVALID_STATE`
        - En reintento (`estado=error`) limpia items previos y registra `ocr_reintento`
        - Soporta imagenes y PDF (`TEXT_DETECTION` / `DOCUMENT_TEXT_DETECTION`)
        - Inserción de items por batch con fallback individual (`items_failed`)
        - `GCV_API_KEY` requerido en entorno para extracción real
        Timeout: 35 segundos.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Extracción completada exitosamente
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          factura_id:
                            type: string
                            format: uuid
                          items_count:
                            type: integer
                          items_failed_count:
                            type: integer
                          items_failed:
                            type: array
                            items:
                              type: object
                              properties:
                                descripcion_original:
                                  type: string
                                error:
                                  type: string
                          insert_mode:
                            type: string
                            enum: [batch, fallback]
                          items_previos_eliminados:
                            type: integer
                          estado:
                            type: string
                            enum: [extraida]
                        required: [factura_id, items_count, estado]
        '400':
          description: Validación fallida (`VALIDATION_ERROR` o `UNSUPPORTED_FILE_TYPE`)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Factura no encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Conflicto de estado de factura (`INVALID_STATE`, por ejemplo no está en `pendiente|error`)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error interno/DB/storage durante extracción OCR
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '502':
          description: Error de servicio OCR aguas arriba (`OCR_ERROR`)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Error de configuración OCR (`CONFIG_ERROR`)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '504':
          description: Timeout en extracción OCR (`OCR_TIMEOUT`)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /facturas/items/{id}/validar:
    put:
      summary: Confirmar o rechazar item extraído de factura
      tags: [Facturas]
      security:
        - BearerAuth: []
      description: |
        Valida un item extraído por OCR. Permite confirmar con producto_id o rechazar.

        - Si `estado_match` = `confirmada`: requiere `producto_id` válido
        - Si `estado_match` = `rechazada`: solo marca como rechazada
        - Cuando TODOS los items están en estado final, factura transiciona a 'validada'

        Requiere: rol admin/deposito
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [estado_match]
              properties:
                estado_match:
                  type: string
                  enum: [confirmada, rechazada]
                producto_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: Requerido si estado_match es 'confirmada'
                guardar_alias:
                  type: boolean
                  default: false
                alias_texto:
                  type: string
                  nullable: true
                  maxLength: 255
      responses:
        '200':
          description: Item actualizado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Validación fallida (estado inválido o producto_id faltante)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Item no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /facturas/{id}/aplicar:
    post:
      summary: Aplicar items confirmados a inventario
      tags: [Facturas]
      security:
        - BearerAuth: []
      description: |
        Aplica los items confirmados de una factura al inventario.

        **Precondiciones:** factura en estado `validada`, al menos un item confirmado,
        y `score_confianza >= OCR_MIN_SCORE_APPLY` (fallback 0.70).

        **Operaciones:** crea movimientos entrada via `sp_movimiento_inventario`,
        persiste precios_compra, transiciona factura a 'aplicada'.

        **Concurrencia:** usa lock optimista (`PATCH ... WHERE id AND estado=validada`).
        Si el lock afecta 0 filas, responde `409 CONFLICT`.

        **Idempotente:** items ya aplicados se saltan (no error).

        **Hardening parcial (T7):** ante error en algun item, los movimientos de entrada
        ya creados se compensan con movimientos `salida` inversos, se limpia el link
        `factura_ingesta_item_id` para permitir reintento limpio, y el estado de la
        factura revierte a `validada`. El evento `aplicacion_rollback` registra
        `items_compensados` y `items_compensacion_fallida`.
        Respuesta 207 si hay errores parciales.

        Requiere: rol admin/deposito
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Factura aplicada exitosamente
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          factura_id:
                            type: string
                            format: uuid
                          items_aplicados:
                            type: integer
                          items_ya_aplicados:
                            type: integer
                          items_errores:
                            type: integer
                          results:
                            type: array
                            items:
                              type: object
                          errors:
                            type: array
                            items:
                              type: object
        '207':
          description: Aplicacion parcial — movimientos compensados, estado revertido a validada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Validación fallida (sin items confirmados o `OCR_CONFIDENCE_BELOW_THRESHOLD`)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Factura no encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Conflicto de estado (ya aplicada o lock optimista perdido)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /health:
    get:
      summary: Health check del gateway
      tags: [Sistema]
      security: []
      responses:
        '200':
          description: Estado del sistema
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          status:
                            type: string
                            enum: [healthy, degraded, unhealthy]
                          uptime_seconds:
                            type: integer
                          version:
                            type: string

  /productos/dropdown:
    get:
      summary: Lista mínima de productos para selectores
      tags: [Productos]
      security: []
      responses:
        '200':
          description: Lista compacta de productos
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                              format: uuid
                            nombre:
                              type: string
                            codigo_barras:
                              type: string

  /proveedores/dropdown:
    get:
      summary: Lista mínima de proveedores para selectores
      tags: [Proveedores]
      security: []
      responses:
        '200':
          description: Lista compacta de proveedores
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                              format: uuid
                            nombre:
                              type: string

  /reservas:
    post:
      summary: Crear reserva de stock
      tags: [Reservas]
      security:
        - BearerAuth: []
      description: |
        Crea una reserva de stock para un producto. Requiere autenticación.
        
        **Idempotencia:** El header `Idempotency-Key` es OBLIGATORIO para prevenir 
        duplicados en reintentos de red. Si la reserva ya existe con esa key, 
        se retorna 200 con `idempotent: true`.
      parameters:
        - name: Idempotency-Key
          in: header
          required: true
          schema:
            type: string
          description: Clave única para garantizar idempotencia (UUID recomendado)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [producto_id, cantidad]
              properties:
                producto_id:
                  type: string
                  format: uuid
                cantidad:
                  type: integer
                  minimum: 1
                referencia:
                  type: string
                  description: Referencia externa (ticket, orden, etc.)
                deposito:
                  type: string
                  default: Principal
      responses:
        '201':
          description: Reserva creada exitosamente
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      idempotent:
                        type: boolean
                        example: false
                      stock_disponible:
                        type: integer
        '200':
          description: Reserva ya existente (idempotente)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      idempotent:
                        type: boolean
                        example: true
                      stock_disponible:
                        type: integer
        '400':
          description: Idempotency-Key faltante o datos inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                idempotency_missing:
                  value:
                    success: false
                    error:
                      code: IDEMPOTENCY_KEY_REQUIRED
                      message: Idempotency-Key es requerido
        '409':
          description: Stock insuficiente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                insufficient_stock:
                  value:
                    success: false
                    error:
                      code: INSUFFICIENT_STOCK
                      message: Stock disponible insuficiente para la reserva
        '503':
          description: Servicio temporalmente no disponible
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /reservas/{id}/cancelar:
    post:
      summary: Cancelar una reserva
      tags: [Reservas]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Reserva cancelada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Reserva no encontrada

  /tareas:
    post:
      summary: Crear nueva tarea
      tags: [Tareas]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [titulo]
              properties:
                titulo:
                  type: string
                descripcion:
                  type: string
                prioridad:
                  type: string
                  enum: [baja, media, alta, urgente]
                  default: media
                asignado_a:
                  type: string
                  format: uuid
                fecha_limite:
                  type: string
                  format: date-time
      responses:
        '201':
          description: Tarea creada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  /tareas/{id}/completar:
    put:
      summary: Marcar tarea como completada
      tags: [Tareas]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Tarea completada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Tarea no encontrada

  /tareas/{id}/cancelar:
    put:
      summary: Cancelar tarea
      tags: [Tareas]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Tarea cancelada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Tarea no encontrada

  # ============================================================================
  # ENDPOINTS DE PEDIDOS (NUEVO)
  # ============================================================================

  /pedidos:
    get:
      summary: Listar pedidos con filtros opcionales
      tags: [Pedidos]
      security:
        - BearerAuth: []
      parameters:
        - name: estado
          in: query
          schema:
            type: string
            enum: [pendiente, preparando, listo, entregado, cancelado]
          description: Filtrar por estado del pedido
        - name: estado_pago
          in: query
          schema:
            type: string
            enum: [pendiente, parcial, pagado]
          description: Filtrar por estado de pago
        - name: fecha_desde
          in: query
          schema:
            type: string
            format: date
          description: Fecha desde (YYYY-MM-DD)
        - name: fecha_hasta
          in: query
          schema:
            type: string
            format: date
          description: Fecha hasta (YYYY-MM-DD)
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Lista de pedidos con detalles
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Pedido'
                      count:
                        type: integer
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    
    post:
      summary: Crear un nuevo pedido
      tags: [Pedidos]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CrearPedidoRequest'
      responses:
        '201':
          description: Pedido creado exitosamente
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          success:
                            type: boolean
                          pedido_id:
                            type: string
                            format: uuid
                          numero_pedido:
                            type: integer
        '400':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: No autorizado

  /pedidos/{id}:
    get:
      summary: Obtener detalle de un pedido
      tags: [Pedidos]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Detalle del pedido con items y cliente
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Pedido'
        '404':
          description: Pedido no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pedidos/{id}/estado:
    put:
      summary: Actualizar estado del pedido
      tags: [Pedidos]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - estado
              properties:
                estado:
                  type: string
                  enum: [pendiente, preparando, listo, entregado, cancelado]
      responses:
        '200':
          description: Estado actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Estado inválido
        '404':
          description: Pedido no encontrado

  /pedidos/{id}/pago:
    put:
      summary: Registrar pago del pedido
      tags: [Pedidos]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - monto_pagado
              properties:
                monto_pagado:
                  type: number
                  format: decimal
                  description: Monto pagado (el estado se calcula automáticamente)
      responses:
        '200':
          description: Pago registrado
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          estado_pago:
                            type: string
                            enum: [pendiente, parcial, pagado]
        '404':
          description: Pedido no encontrado

  /pedidos/items/{id}:
    put:
      summary: Marcar item como preparado/no preparado
      tags: [Pedidos]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID del item (detalle_pedido)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - preparado
              properties:
                preparado:
                  type: boolean
                  description: true para marcar como preparado, false para desmarcar
      responses:
        '200':
          description: Item actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Item no encontrado

  # ============================================================================
  # SEARCH / INSIGHTS / POS / CLIENTES / OFERTAS / BITÁCORA (NUEVO)
  # ============================================================================

  /search:
    get:
      summary: Búsqueda global (productos, proveedores, tareas, pedidos, clientes)
      tags: [Search]
      security:
        - BearerAuth: []
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 2
          description: Término de búsqueda (mín 2 caracteres)
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 20
            default: 10
      responses:
        '200':
          description: Resultados agrupados por entidad
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/SearchResponse'
        '400':
          description: Validación fallida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /insights/arbitraje:
    get:
      summary: Insights de arbitraje (riesgo de pérdida / margen bajo)
      tags: [Insights]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de productos con flags de riesgo/margen
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/InsightArbitrajeItem'

  /insights/compras:
    get:
      summary: Insights de compras (stock bajo + caída de costo)
      tags: [Insights]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de oportunidades de compra
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/InsightCompraItem'

  /insights/producto/{id}:
    get:
      summary: Insight unificado de arbitraje por producto
      tags: [Insights]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Insight del producto
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/InsightArbitrajeItem'
        '404':
          description: Sin datos de arbitraje
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /clientes:
    get:
      summary: Listar clientes (incluye saldo de cuenta corriente)
      tags: [Clientes]
      security:
        - BearerAuth: []
      parameters:
        - name: q
          in: query
          required: false
          schema: { type: string }
          description: Buscar por nombre / teléfono / email
        - name: limit
          in: query
          required: false
          schema: { type: integer, default: 50, minimum: 1, maximum: 200 }
        - name: offset
          in: query
          required: false
          schema: { type: integer, default: 0, minimum: 0 }
      responses:
        '200':
          description: Lista de clientes con saldo
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items: { $ref: '#/components/schemas/ClienteSaldoItem' }
        '400':
          description: Error de validación
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

    post:
      summary: Crear cliente
      tags: [Clientes]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClienteCreateRequest'
      responses:
        '201':
          description: Cliente creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  /clientes/{id}:
    put:
      summary: Actualizar cliente
      tags: [Clientes]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClienteUpdateRequest'
      responses:
        '200':
          description: Cliente actualizado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SuccessResponse' }
        '404':
          description: Cliente no encontrado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /cuentas-corrientes/resumen:
    get:
      summary: Resumen de cuenta corriente ("dinero en la calle")
      tags: [Cuentas Corrientes]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Resumen
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/CuentaCorrienteResumen'

  /cuentas-corrientes/saldos:
    get:
      summary: Saldos por cliente (cuenta corriente)
      tags: [Cuentas Corrientes]
      security:
        - BearerAuth: []
      parameters:
        - name: q
          in: query
          required: false
          schema: { type: string }
        - name: solo_deuda
          in: query
          required: false
          schema: { type: boolean, default: false }
        - name: limit
          in: query
          required: false
          schema: { type: integer, default: 50, minimum: 1, maximum: 200 }
        - name: offset
          in: query
          required: false
          schema: { type: integer, default: 0, minimum: 0 }
      responses:
        '200':
          description: Lista de saldos
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items: { $ref: '#/components/schemas/ClienteSaldoItem' }

  /cuentas-corrientes/pagos:
    post:
      summary: Registrar pago de cuenta corriente
      tags: [Cuentas Corrientes]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RegistrarPagoCCRequest' }
      responses:
        '201':
          description: Pago registrado
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/RegistrarPagoCCResponse'

  /ventas:
    post:
      summary: Crear venta POS (idempotente)
      tags: [Ventas]
      security:
        - BearerAuth: []
      parameters:
        - name: Idempotency-Key
          in: header
          required: true
          schema: { type: string }
          description: Header obligatorio para idempotencia (evita duplicados)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/VentaCreateRequest' }
      responses:
        '201':
          description: Venta creada
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/VentaResponse'
        '200':
          description: Venta existente (idempotente)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/VentaResponse'

    get:
      summary: Listar ventas
      tags: [Ventas]
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          required: false
          schema: { type: integer, default: 50, minimum: 1, maximum: 200 }
        - name: offset
          in: query
          required: false
          schema: { type: integer, default: 0, minimum: 0 }
      responses:
        '200':
          description: Lista de ventas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  /ventas/{id}:
    get:
      summary: Obtener detalle de venta
      tags: [Ventas]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Detalle de venta + items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Venta no encontrada
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /ofertas/sugeridas:
    get:
      summary: Ofertas sugeridas (<= 7 días)
      tags: [Ofertas]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de sugerencias
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items: { $ref: '#/components/schemas/OfertaSugeridaItem' }

  /ofertas/aplicar:
    post:
      summary: Aplicar oferta por stock_id
      tags: [Ofertas]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/OfertaAplicarRequest' }
      responses:
        '201':
          description: Oferta aplicada
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SuccessResponse' }

  /ofertas/{id}/desactivar:
    post:
      summary: Desactivar oferta por id
      tags: [Ofertas]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Oferta desactivada
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SuccessResponse' }
        '404':
          description: Oferta no encontrada
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /bitacora:
    post:
      summary: Crear nota de turno (bitácora)
      tags: [Bitácora]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BitacoraCreateRequest' }
      responses:
        '201':
          description: Nota registrada
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/BitacoraItem'

    get:
      summary: Listar notas de bitácora
      tags: [Bitácora]
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          required: false
          schema: { type: integer, default: 50, minimum: 1, maximum: 200 }
        - name: offset
          in: query
          required: false
          schema: { type: integer, default: 0, minimum: 0 }
      responses:
        '200':
          description: Lista de notas
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items: { $ref: '#/components/schemas/BitacoraItem' }
