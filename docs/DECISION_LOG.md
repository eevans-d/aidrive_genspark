# DECISION LOG (Canonico)

**Ultima actualizacion:** 2026-03-01 (Sprint 1.1 Asistente IA — UX improvements)

## Decisiones activas y vigentes

| ID | Decision | Estado | Fecha | Evidencia |
|---|---|---|---|---|
| D-086 | Politica `verify_jwt`: solo `api-minimarket` puede operar con `verify_jwt=false`; resto de funciones `verify_jwt=true`. | Vigente | 2026-02-12 | `docs/closure/OPEN_ISSUES.md` |
| D-155 | OCR de facturas estandarizado en Google Cloud Vision; secret requerido: `GCV_API_KEY`. | Vigente | 2026-02-23 | `docs/ESTADO_ACTUAL.md`, `.env.example:25` |
| D-156 | Dependency governance fail-fast en CI para alineacion critica de dependencias. | Vigente | 2026-02-24 | `scripts/check-supabase-js-alignment.mjs`, `scripts/check-critical-deps-alignment.mjs` |
| D-158 | Auditoria integral 0-8 re-ejecutada: veredicto inicial `REQUIERE ACCION` por hallazgos `ALTO` en dependencias frontend. | Historico | 2026-02-25 | `docs/closure/archive/historical/FINAL_REPORT_CODEX_GO_LIVE_2026-02-25.md` |
| D-159 | Depuracion documental absoluta: eliminacion de documentacion duplicada/antigua, consolidacion a fuente unica y prompt canonico unico. | Vigente | 2026-02-25 | `docs/closure/README_CANONICO.md`, `docs/closure/archive/historical/DEPURACION_DOCUMENTAL_2026-02-25.md` |
| D-160 | Cierre post-auditoria de hallazgos documentales A-004..A-007. | Vigente | 2026-02-25 | `.env.example`, `docs/closure/OPEN_ISSUES.md` |
| D-161 | Remediacion completa: 7 hallazgos cerrados (A-001..A-003, A-008..A-011). `react-router-dom` 6.30.3, `pnpm.overrides` para 5 deps transitivas, `@ts-expect-error`, test NotFound, validacion estricta E2E, documentacion arquitectural dual-source rol. Veredicto: `GO INCONDICIONAL`. | Vigente | 2026-02-25 | `docs/closure/archive/historical/INFORME_REMEDIACION_FINAL_2026-02-25_041847.md` |
| D-162 | Revalidacion 2026-02-26: `ProductionGate` 18/18 PASS (score 100). Se normaliza Gate 7 para excluir `node_modules` y fixtures/tests, y se versiona `PERF_BASELINE_*` para Gate 17. Se mantiene veredicto `GO INCONDICIONAL`. | Vigente | 2026-02-26 | `docs/PRODUCTION_GATE_REPORT.md`, `.agent/skills/ProductionGate/SKILL.md`, `docs/closure/PERF_BASELINE_2026-02-26_081540.md` |
| D-163 | Re-chequeo cruzado 2026-02-27: Gate 7 confirmado sin matches en codigo productivo; baseline perf multi-endpoint autenticado sigue parcial por ausencia de `TEST_USER_ADMIN` y `TEST_PASSWORD` en `.env.test`. Se mantiene `GO INCONDICIONAL` y se deja mejora recomendada no bloqueante. | Vigente | 2026-02-27 | `docs/closure/OPEN_ISSUES.md`, `docs/ESTADO_ACTUAL.md`, `docs/closure/PERF_BASELINE_2026-02-26_081540.md`, `docs/closure/archive/historical/RECHECK_GO_2026-02-27.md` |
| D-164 | Se define `docs/PLAN_FUSIONADO_FACTURAS_OCR.md` como unico plan canonico para ejecucion OCR. `PLAN_FACTURAS_OCR.md` y `PLAN_MAESTRO_OCR_FACTURAS.md` quedan deprecados como antecedentes historicos. | Vigente | 2026-02-27 | `docs/PLAN_FUSIONADO_FACTURAS_OCR.md`, `docs/archive/planes-deprecados/PLAN_FACTURAS_OCR.md`, `docs/archive/planes-deprecados/PLAN_MAESTRO_OCR_FACTURAS.md` |
| D-165 | Se separa explicitamente el estado global (`GO INCONDICIONAL`) del estado del modulo OCR (backlog abierto priorizado) para evitar falsas conclusiones de cierre total. | Vigente | 2026-02-27 | `docs/ESTADO_ACTUAL.md`, `docs/closure/OPEN_ISSUES.md` |
| D-166 | Se archivan en `docs/archive/planes-deprecados/` las planificaciones deprecadas para mantener `docs/` enfocado en ejecucion activa y reducir ambiguedad operativa. | Vigente | 2026-02-28 | `README.md`, `AGENTS.md`, `docs/ESTADO_ACTUAL.md`, `docs/PLAN_FUSIONADO_FACTURAS_OCR.md` |
| D-167 | Cross-check PLAN_FUSIONADO T1-T10 contra codigo real: 0 completadas, 2 parciales (T3, T7), 8 no implementadas. GCV BLOCKED (timeout). Se corrigieron: CUITs en BD, timeout handling en edge function, deploy verificado. Scripts batch y seed operativos. | Vigente | 2026-02-28 | `docs/ESTADO_ACTUAL.md`, `docs/closure/archive/historical/REVIEW_POST_COPILOT_CONTINUACION_2026-02-28.md`, `docs/closure/OPEN_ISSUES.md` |
| D-168 | Re-check operativo integral post-Claude/Copilot: tests `1736/1736`, `68/68`, `240/240` PASS; `supabase functions list` confirma 15 funciones ACTIVE; OCR sigue bloqueado externamente con `504 OCR_TIMEOUT` confirmado en reintento. Se ajusta metadata operativa (`functions_deployed: 15`) y deteccion HC-1 para ignorar falsos positivos en bloques SQL comentados. | Vigente | 2026-02-28 | `docs/ESTADO_ACTUAL.md`, `docs/REALITY_CHECK_UX.md`, `docs/closure/OPEN_ISSUES.md`, `.agent/skills/project_config.yaml`, `.agent/skills/RealityCheck/SKILL.md` |
| D-169 | T1 implementada: gateway `POST /facturas/{id}/extraer` ahora exige estado `pendiente` antes de invocar OCR; si no, retorna `409 INVALID_STATE`. Se agrega cobertura unitaria de validador de estado OCR y suite completa queda `1736/1736 PASS`. | Vigente | 2026-02-28 | `supabase/functions/api-minimarket/index.ts`, `supabase/functions/api-minimarket/helpers/validation.ts`, `tests/unit/gateway-validation.test.ts`, `docs/closure/OPEN_ISSUES.md` |
| D-170 | Continuidad OCR: se cierran T2/T5/T6/T8/T9/T10. Extracción ahora permite `pendiente|error` con limpieza de items y evento `ocr_reintento`; matching con cache por request; insert batch con fallback y reporte `items_failed`; soporte PDF (`DOCUMENT_TEXT_DETECTION`); warning UI por CUIT mismatch; contrato OpenAPI/API_README sincronizado con runtime. Queda abierto solo T7 parcial (rollback funcional por item). | Historico | 2026-02-28 | `supabase/functions/facturas-ocr/index.ts`, `supabase/functions/facturas-ocr/helpers.ts`, `minimarket-system/src/pages/Facturas.tsx`, `docs/api-openapi-3.1.yaml`, `docs/API_README.md`, `docs/ESTADO_ACTUAL.md`, `docs/closure/OPEN_ISSUES.md` |
| D-171 | T7 completado: hardening de `/facturas/{id}/aplicar` ante fallos parciales. Ante error en iteracion de items, se crean movimientos `salida` compensatorios via `sp_movimiento_inventario` para revertir stock, se limpia `factura_ingesta_item_id` en movimientos originales para permitir reintento idempotente, y se registra evento `aplicacion_rollback` con campos `items_compensados`/`items_compensacion_fallida`. Backlog OCR: 10/10 tareas cerradas. | Vigente | 2026-03-01 | `supabase/functions/api-minimarket/index.ts`, `tests/unit/facturas-aplicar-hardening.test.ts`, `docs/ESTADO_ACTUAL.md`, `docs/closure/OPEN_ISSUES.md` |
| D-172 | Revalidacion intensiva pre-entrega (2026-03-01): ProductionGate re-ejecutado con `18/18 PASS` (score 100), RealityCheck actualizado sin blockers UX P0 y sincronizacion DocuGuard aplicada. Se normaliza `.env.example` agregando `OCR_MIN_SCORE_APPLY` para alinear documentacion de entorno con runtime de `/facturas/{id}/aplicar`. | Vigente | 2026-03-01 | `docs/PRODUCTION_GATE_REPORT.md`, `docs/REALITY_CHECK_UX.md`, `.env.example`, `docs/ESTADO_ACTUAL.md`, `docs/closure/DOCUGUARD_REPORT_2026-03-01_032825.md` |
| D-173 | Higiene documental intensiva de `docs/closure`: se incorpora reporte automatico de clasificacion (`activos/historicos/deprecados`), se actualiza `README_CANONICO` con lista explicita de prompts deprecados y se marca `PROMPT_CLAUDE_CODE_GO_INCONDICIONAL_2026-02-27.md` como deprecado para evitar uso en continuidad. | Vigente | 2026-03-01 | `scripts/generate-closure-hygiene-report.mjs`, `docs/closure/CLOSURE_HYGIENE_REPORT_2026-03-01.md`, `docs/closure/README_CANONICO.md`, `docs/closure/PROMPT_CLAUDE_CODE_GO_INCONDICIONAL_2026-02-27.md` |
| D-174 | Se ejecuta archivado estructural de historicos en `docs/closure`: 38 archivos movidos a `docs/closure/archive/historical/` con reescritura automatica de referencias en markdown para preservar trazabilidad y evitar ruido en la raiz operativa. | Vigente | 2026-03-01 | `scripts/archive-closure-historical.mjs`, `docs/closure/archive/historical/*`, `docs/closure/archive/INDEX.md`, `docs/closure/LATEST_AUTOGEN_REPORTS.md` |
| D-175 | Se institucionaliza mantenimiento documental continuo con scripts dedicados: generacion de indice de archivo, policy-check de raiz y comando orquestado `docs:closure-maintenance` para ejecutar archivado+indices+higiene+control de drift en una sola corrida. | Vigente | 2026-03-01 | `scripts/generate-closure-archive-index.mjs`, `scripts/check-closure-root-policy.mjs`, `package.json`, `docs/closure/README_CANONICO.md` |
| D-176 | Hardening post-archivo: se corrigen referencias stale fuera de `docs/` (`.agent/workflows`, `.github/copilot-instructions`) y se amplia el rewriter de archivado para incluir markdown en `.agent/` y `.github/`, evitando drift futuro de rutas `docs/closure/*` hacia historicos movidos. | Vigente | 2026-03-01 | `.agent/workflows/session-start.md`, `.github/copilot-instructions.md`, `scripts/archive-closure-historical.mjs`, `scripts/update-latest-autogen-reports.mjs` |
| D-177 | **Auditoría de producción profunda:** se ejecutó análisis de ingeniería inversa simulando escenarios reales en gateway, facturas-ocr y frontend. Se detectaron **50+ hallazgos** (1 CRITICO seguridad, 2 CRITICOS integridad datos, 8 HIGH, 19 MEDIUM, 7 LOW). Se implementaron **11 fixes**: (1) RL-01 sanitización de errores PostgREST para no filtrar detalles SQL a clientes en 5xx; (2) MISC-02 sanitización de `x-request-id` del cliente (max 128 chars alfanumericoS); (3) ES-03 audit event envuelto en try-catch en `/aplicar`; (4) PW-02 fallo de link movimiento ahora activa compensación; (5) TC-01 validación de cantidad antes de SP; (6) M1 límites de tamaño de imagen OCR (min 1KB, max 10MB); (7) F1+S1 try-catch JSON parse de GCV + sanitización de API key en errores; (8) F2+D3 CRITICO: estado `extraida` se setea DESPUÉS de persistir items (no antes); PATCH response ahora se verifica; (9) S2 eliminación de fallback JWT no verificado en internal-auth (cerraba bypass de auth); (10) F3 req.json() envuelto en try-catch; (11) Frontend: `extracting`/`applying` migrados de `string|null` a `Set<string>` para tracking correcto de operaciones concurrentes. Tests: **1776 unit + 68 integration + 242 component + 17 contract = ALL PASS**. | Vigente | 2026-03-01 | `supabase/functions/api-minimarket/index.ts`, `supabase/functions/facturas-ocr/index.ts`, `supabase/functions/_shared/internal-auth.ts`, `minimarket-system/src/pages/Facturas.tsx`, `tests/unit/shared-internal-auth.test.ts`, `tests/security/security.vitest.test.ts` |
| D-178 | **Sprint 1 Asistente IA (read-only):** nueva edge function `api-assistant` con parser rule-based de 5 intents de solo lectura (stock bajo, pedidos pendientes, cuentas corrientes, ventas del dia, estado OCR facturas). Auth de usuario por JWT + verificacion de rol confiable desde `app_metadata` (sin `service-role` y sin confiar en `user_metadata`). Frontend: pagina `Asistente.tsx` con chat, quick-prompts, sugerencias. Ruta `/asistente` protegida admin-only. Se detectó gap H-001 (no hay GET endpoint para `facturas_ingesta`) y se resolvió con PostgREST directo. Se simplificó el contrato de respuesta eliminando campos de Sprint 2 (`confirm_token`, `action_payload`). Tests: **1853 unit (84 files) + 242 component (47 files) = ALL PASS**. Build y lint limpios. | Vigente | 2026-03-01 | `supabase/functions/api-assistant/index.ts`, `supabase/functions/api-assistant/parser.ts`, `supabase/functions/api-assistant/auth.ts`, `minimarket-system/src/pages/Asistente.tsx`, `minimarket-system/src/lib/assistantApi.ts`, `minimarket-system/src/lib/roles.ts:39`, `minimarket-system/src/App.tsx:30,230`, `minimarket-system/src/components/Layout.tsx:44`, `minimarket-system/src/pages/Dashboard.tsx:21`, `tests/unit/assistant-intent-parser.test.ts`, `tests/unit/assistant-auth-role.test.ts` |
| D-179 | **Sprint 1.1 Asistente IA (UX improvements):** auditoria tecnica+UX del asistente detecto 2 ALTO (timezone mismatch en ventas, ausencia de navegacion accionable) + 5 MEDIO (etiquetas dev, intents crudos, sin greeting/help, confianza estatica, timezone ignorado) + 2 BAJO. Se implementaron 4 fixes de alto impacto: (1) navigation deep-links en respuestas — cada intent retorna `navigation[]` con label+path, frontend renderiza botones accionables; (2) intents `saludo` y `ayuda` para manejar saludos y pedidos de ayuda sin "no entendi"; (3) etiquetas user-friendly en UI — eliminado "Sprint 1", eliminado "Intent: consultar_...", reemplazado por etiquetas legibles; (4) fix timezone — `handleVentasDia` usa `Intl.DateTimeFormat` con TZ del cliente en vez de UTC del servidor. Contrato API extendido (backwards-compatible): campo opcional `navigation?: Array<{label, path}>`. Tests: **1867/1867 unit PASS** (91 asistente). Build y lint limpios. | Vigente | 2026-03-01 | `supabase/functions/api-assistant/index.ts`, `supabase/functions/api-assistant/parser.ts`, `minimarket-system/src/pages/Asistente.tsx`, `minimarket-system/src/lib/assistantApi.ts`, `tests/unit/assistant-intent-parser.test.ts`, `docs/PLAN_ASISTENTE_IA_DASHBOARD.md` |
| D-180 | **Sprint 1.2 Asistente IA (UX polish):** (1) Contextual fallback — nueva funcion `findRelevantSuggestions()` detecta keywords (factura, stock, pedido, venta, deuda/cliente) en mensajes no reconocidos y retorna sugerencias focalizadas en vez de lista generica; el backend genera un mensaje mas orientador ("quizas quisiste decir..."); (2) Retry button — error banner ahora ofrece boton "Reintentar" que re-envia el ultimo mensaje fallido; (3) Loading indicator — muestra "Consultando..." con texto junto al spinner para feedback visual claro. Tests: **1874/1874 unit PASS** (98 asistente: 95 parser + 3 auth). Build y lint limpios. | Vigente | 2026-03-01 | `supabase/functions/api-assistant/parser.ts`, `supabase/functions/api-assistant/index.ts`, `minimarket-system/src/pages/Asistente.tsx`, `tests/unit/assistant-intent-parser.test.ts` |

## Regla de uso
- Este log mantiene decisiones activas + hitos historicos minimos de trazabilidad.
- El detalle operativo diario vive en `docs/closure/OPEN_ISSUES.md` y en el ultimo paquete de auditoria.
