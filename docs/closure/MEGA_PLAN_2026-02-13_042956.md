# Mega Plan Absoluto y Definitivo — Auditoria Forense 2026-02-13

- Version: `v2.0-definitiva`
- Fecha base (UTC): `2026-02-13 04:29:56`
- Fecha de consolidacion (UTC): `2026-02-13`
- Objetivo rector: cerrar reservas criticas de auditoria y llevar el sistema a estado `LISTO PARA PILOTO SIN RESERVAS CRITICAS`.
- Alcance: planificacion ejecutable, sin implementacion en este documento.

## 1. Fuente de verdad y reglas de ejecucion

- Fuentes obligatorias:
`docs/AUDITORIA_FORENSE_ABSOLUTA_2026-02-13.md`
`docs/ESTADO_ACTUAL.md`
`docs/HOJA_RUTA_ACTUALIZADA_2026-02-08.md`
`docs/DECISION_LOG.md`
`docs/closure/OPEN_ISSUES.md`
- Guardrails operativos:
`api-minimarket` debe mantenerse con `verify_jwt=false` en deploy.
No exponer secretos/JWTs.
No usar comandos destructivos de git.
- Criterio de realidad:
cualquier estado "cerrado" requiere evidencia verificable en `docs/closure/` o `test-reports/`.

## 2. Estado consolidado de partida

- Estado global: `CON RESERVAS`.
- Gates cerrados: 3, 4, 15, 18.
- Gate parcial: 16 (`VITE_SENTRY_DSN` pendiente owner).
- Riesgos criticos activos:
seguridad operativa interna cron,
efectividad real de security tests,
enforcement de coverage/CI,
seguridad auth de referencia preproduccion,
control de deploy por rama.

## 3. Production Readiness Score

| Gate | Peso | Estado actual | Puntaje |
|---|---:|---|---:|
| Tests pasan (unit+integration+e2e) | 15 | PASS historico; falta elevar pruebas reales de seguridad/integracion | 10 |
| Build OK | 10 | PASS documentado | 10 |
| Security limpio (RLS/secrets/CORS/auth) | 15 | RLS fuerte; reservas en auth cron y auth config | 6 |
| UX completo | 10 | ErrorMessage 13/13; faltan 404 y cobertura de 5 paginas | 8 |
| Cron jobs funcionales | 10 | auth SQL cerrada; guard interno no uniforme | 6 |
| Docs actualizadas | 10 | sincronizadas al 2026-02-13 | 10 |
| Deploy script seguro | 10 | sin allowlist de branch | 6 |
| Performance baseline | 10 | baseline existe; falta rebaseline post-remediacion | 8 |
| Env vars alineadas | 5 | pendiente owner Sentry/SendGrid | 2 |
| Rollback plan | 5 | backup+restore drill documentado | 4 |

**Score actual: `70/100`**
**Meta de salida: `>=85/100`**

## 4. Top 10 absoluto (ejecucion priorizada)

| ID | Prioridad | Modulo/Submodulo | Tarea | Impacto | Riesgo | Skill | DoD |
|---|---|---|---|---:|---|---|---|
| T01 | P0 | M3.S1 | Guard interno uniforme (`requireServiceRoleAuth`) en cron sensibles | 3 | Alto | `CronFixOps` | 0 endpoints internos criticos sin guard |
| T02 | P0 | M5.S1 | Reescribir security tests a escenarios reales/contractuales | 3 | Alto | `TestMaster` | Security suite valida runtime real |
| T03 | P0 | M5.S2 | Endurecer coverage/CI y eliminar bypass de coverage unit | 2 | Alto | `TestMaster` | Coverage policy y CI quedan coherentes |
| T04 | P0 | M8.S1 | Validacion de rama permitida en `deploy.sh` | 2 | Alto | `DeployOps` | no deploy productivo desde rama invalida |
| T05 | P1 | M6.S1 | Plan de hardening auth preproduccion (confirmaciones/password/MFA) | 2 | Alto | `SecurityAudit` | matriz target auth aprobada |
| T06 | P1 | M2.S1 | Catch-all 404 + test navegacion invalida | 1 | Medio | `CodeCraft` | 404 controlado y testeado |
| T07 | P1 | M2.S2 | Cobertura en 5 paginas sin tests | 2 | Medio | `TestMaster` | 5 paginas con tests smoke minimos |
| T08 | P1 | M3.S2 | Redaccion/mascara PII en cron-notifications | 2 | Medio | `SecurityAudit` | no persistencia/log sensible en claro |
| T09 | P1 | M6.S2 | Cierre owner: Sentry DSN + rotacion SendGrid | 2 | Medio | `SentryOps` + `SendGridOps` + `SecretRotationOps` | evidencias activas sin exponer secretos |
| T10 | P1 | M7.S1 | Sincronizacion documental final post-cierre tecnico | 1 | Medio | `DocuGuard` + `APISync` | 0 desalineaciones criticas canonicamente |

## 5. Planificacion general por modulos y submodulos

## M1 Arquitectura

| Submodulo | Objetivo | Tareas concretas | DoD | Verificacion | Evidencia |
|---|---|---|---|---|---|
| M1.S1 Versionado SDK | Reducir drift de SDK Supabase | definir estrategia de versionado por superficie; registrar ADR | version policy unica aprobada | check de versiones en 3 manifests | `docs/DECISION_LOG.md` + log tecnico |
| M1.S2 Higiene de codigo | Resolver dead code | eliminar o justificar `extractUserRole` | 0 dead code sin decision explicita | busqueda de usos productivos | reporte en `docs/closure/` |
| M1.S3 Consistencia monorepo | Unificar reglas de checks | matriz de checks por entorno/paquete | pipeline y scripts coherentes | ejecucion gates all | `test-reports/quality-gates_*.log` |

## M2 Frontend

| Submodulo | Objetivo | Tareas concretas | DoD | Verificacion | Evidencia |
|---|---|---|---|---|---|
| M2.S1 Routing resiliente | Manejo de ruta invalida | crear ruta `*` + pantalla controlada | rutas invalidas no quedan en blanco | test de navegacion invalida | `minimarket-system/src` tests |
| M2.S2 Cobertura paginas criticas | tests faltantes | Kardex/Pocket/Proveedores/Rentabilidad/Stock | 5 tests smoke nuevos PASS | `pnpm ... test:components` + unit | junit + reporte |
| M2.S3 UX operativa | consolidar loading/error/empty | checklist de UX por pagina | checklist PASS pagina a pagina | QA checklist | evidencia UX en `docs/closure/` |

## M3 Backend

| Submodulo | Objetivo | Tareas concretas | DoD | Verificacion | Evidencia |
|---|---|---|---|---|---|
| M3.S1 Auth interna cron | endurecer entrada HTTP interna | agregar guard en entrypoints cron sensibles | 0 endpoints criticos sin guard | tests 401/200 por endpoint | `docs/closure/EVIDENCIA_CRON_AUTH_*.md` |
| M3.S2 Telemetria segura | minimizar exposicion PII | redaccion de `subject`, `recipients`, `data` | logs y persistencia sin PII en claro | grep de campos sensibles + tests | evidencia seguridad |
| M3.S3 Contrato api-minimarket | preservar contrato de auth app | verificar despliegue con `--no-verify-jwt` | contrato sin regresion | dry-run deploy + checks auth | execution log + baseline |

## M4 Base de Datos

| Submodulo | Objetivo | Tareas concretas | DoD | Verificacion | Evidencia |
|---|---|---|---|---|---|
| M4.S1 RLS continuidad | sostener validacion fina | revalidacion programada scripts RLS | PASS continuo | `scripts/rls_*` | logs RLS en `docs/closure/` |
| M4.S2 Operacion cron/MV | clarificar runbook cron y refresh | actualizar runbook segun entorno real | operacion reproducible | checklist operacion | runbook actualizado |
| M4.S3 Esquema documentado | eliminar drift de esquema | sincronizar doc esquema con migraciones | 0 tablas/vistas criticas omitidas | diff doc vs migraciones | `docs/ESQUEMA_BASE_DATOS_ACTUAL.md` |

## M5 Testing

| Submodulo | Objetivo | Tareas concretas | DoD | Verificacion | Evidencia |
|---|---|---|---|---|---|
| M5.S1 Security tests efectivos | salir de mock-only | cubrir auth/cors/input abuse con escenarios reales | suite security robusta | run security suite + casos reales | junit security |
| M5.S2 Coverage gobernada | alinear politica y CI | actualizar thresholds/enforcement segun decision | governance consistente | run CI local/simulada | evidencia CI |
| M5.S3 Integracion real | reducir dependencia de mocks | ampliar integration real en rutas criticas | integration híbrida verificable | run integration + smoke | reportes integration/e2e |

## M6 Seguridad

| Submodulo | Objetivo | Tareas concretas | DoD | Verificacion | Evidencia |
|---|---|---|---|---|---|
| M6.S1 Auth hardening | preproduccion segura | matriz target para `supabase/config.toml` | decisiones y target aprobados | checklist auth | ADR/Decision log |
| M6.S2 Secretos y terceros | cierre de pendientes owner | DSN Sentry + rotacion SendGrid | pendientes owner en 0 | validacion funcional | evidencias Gate 16 y rotacion |
| M6.S3 Riesgos heredados | resolver pendientes historicos | decision final leaked password protection | estado final documentado | verificacion dashboard/politica | decision formal |

## M7 Documentacion

| Submodulo | Objetivo | Tareas concretas | DoD | Verificacion | Evidencia |
|---|---|---|---|---|---|
| M7.S1 Estado canonico | mantener foto vigente | actualizar `ESTADO_ACTUAL` al cierre de bloque | seccion vigente clara + historico claro | review documental | commit/doc diff |
| M7.S2 API/Esquema | sincronizacion funcional | APISync de endpoints y esquema | 0 doc fantasma critico | diff docs vs code | reporte APISync |
| M7.S3 Evidencias | centralizar trazabilidad | index de evidencias por gate | trazabilidad completa | checklist evidencias | `docs/closure/README_CANONICO.md` |

## M8 DevOps/CI

| Submodulo | Objetivo | Tareas concretas | DoD | Verificacion | Evidencia |
|---|---|---|---|---|---|
| M8.S1 Deploy safety | control por rama | agregar allowlist branch en deploy | fail-fast correcto | dry-run en ramas distintas | log deploy |
| M8.S2 Checks pre-commit | cobertura frontend/backend | incluir check backend Deno en pre-commit | hook integral y reproducible | run hook local | evidencia QA |
| M8.S3 Performance/ops | medir impacto post-fixes | nuevo baseline comparativo | p50/p95 documentados | scripts perf baseline | reporte perf nuevo |

## 6. Cronograma semanal operativo (dia por dia)

## Semana 1 (hardening tecnico)

| Dia | Objetivo del dia | Modulos/Submodulos | Entregables del dia |
|---|---|---|---|
| Dia 1 | Cerrar quick wins y preparar base | M2.S1, M7.S1 | ruta 404 planificada + checklist documental base |
| Dia 2 | Seguridad backend interna | M3.S1 | plan de auth interna cron y matriz endpoint->guard |
| Dia 3 | Calidad de pruebas seguridad | M5.S1 | blueprint de security tests reales |
| Dia 4 | Gobernanza CI/coverage | M5.S2, M8.S2 | propuesta cerrada de enforcement + pre-commit integral |
| Dia 5 | Deploy safety + contratos | M8.S1, M3.S3 | politica de rama y contrato `api-minimarket` validados |
| Dia 6 | Hardening auth preprod | M6.S1 | matriz target auth aprobada |
| Dia 7 | Re-check semana 1 | M7.S3 | reporte de cierre semanal con gaps remanentes |

## Semana 2 (cobertura, datos y cierre owner)

| Dia | Objetivo del dia | Modulos/Submodulos | Entregables del dia |
|---|---|---|---|
| Dia 8 | Cobertura de paginas faltantes | M2.S2 | plan de 5 pruebas faltantes cerrado |
| Dia 9 | Telemetria segura | M3.S2 | matriz de redaccion PII en logs/persistencia |
| Dia 10 | Integracion real en rutas criticas | M5.S3 | plan integration real + smoke controlado |
| Dia 11 | Sincronizacion API/esquema | M7.S2, M4.S3 | drift documental a cero (objetivo) |
| Dia 12 | Operacion DB/cron/MV | M4.S2 | runbook unificado y verificable |
| Dia 13 | Cierre owner (externo) | M6.S2 | DSN + SendGrid/rotacion listos para validacion final |
| Dia 14 | Cierre definitivo del plan | M7.S1, M7.S3 | score recalculado + veredicto final |

## 7. Dependencias y ruta critica

- Ruta critica primaria:
T01 -> T02 -> T03 -> T04 -> T09 -> T10
- Dependencias clave:
T09 depende de accion owner externa.
T10 depende de cierre de T01-T09 para foto final coherente.
M4.S2 depende de claridad de entorno real (pg_cron/runbook).

## 8. Quality gates por fase

```bash
.agent/scripts/p0.sh gates all
npm run test:unit
npm run test:integration
npm run test:e2e
pnpm -C minimarket-system lint
pnpm -C minimarket-system build
pnpm -C minimarket-system test:components
```

- Gate de salida Semana 1:
no bloqueantes P0 abiertos en T01-T04.
- Gate de salida Semana 2:
pendientes owner en 0 y score >=85.

## 9. Evidencia minima obligatoria

- Ejecucion por bloque:
`docs/closure/EXECUTION_LOG_<YYYY-MM-DD>_<scope>.md`
- Gates:
`test-reports/quality-gates_<timestamp>.log`
- Cambios de decision:
`docs/DECISION_LOG.md`
- Estado consolidado:
`docs/ESTADO_ACTUAL.md`
- Cierre definitivo:
`docs/closure/MEGA_PLAN_2026-02-13_042956.md` (este documento + seccion de cierre)

## 10. Matriz definitiva modulo -> submodulo -> top task

| Modulo | Submodulo | Top task asociado |
|---|---|---|
| M1 | M1.S1 | T10 |
| M1 | M1.S2 | T10 |
| M1 | M1.S3 | T03 |
| M2 | M2.S1 | T06 |
| M2 | M2.S2 | T07 |
| M2 | M2.S3 | T07 |
| M3 | M3.S1 | T01 |
| M3 | M3.S2 | T08 |
| M3 | M3.S3 | T04 |
| M4 | M4.S1 | T10 |
| M4 | M4.S2 | T10 |
| M4 | M4.S3 | T10 |
| M5 | M5.S1 | T02 |
| M5 | M5.S2 | T03 |
| M5 | M5.S3 | T02 |
| M6 | M6.S1 | T05 |
| M6 | M6.S2 | T09 |
| M6 | M6.S3 | T09 |
| M7 | M7.S1 | T10 |
| M7 | M7.S2 | T10 |
| M7 | M7.S3 | T10 |
| M8 | M8.S1 | T04 |
| M8 | M8.S2 | T03 |
| M8 | M8.S3 | T10 |

## 11. Backlog fuera del Top 10 (parking lot)

- Integracion real ampliada para `/reservas` con dataset controlado.
- Limpieza de historicos obsoletos en `OPEN_ISSUES` y `ESTADO_ACTUAL`.
- Hardening adicional de observabilidad backend (taxonomia de eventos y severidad).

## 12. Criterio de cierre absoluto y definitivo

- Top 10 completado o replanificado con justificacion formal.
- Production Readiness Score >= 85/100.
- Gate 16 cerrado (DSN operativo en entorno objetivo).
- Pendientes owner en 0.
- Veredicto final documental:
`LISTO PARA PILOTO SIN RESERVAS CRITICAS`.

## 13. Seccion de revision final (control de calidad del plan)

Checklist de cierre documental de este plan:
- [x] Incluye plan general por modulos.
- [x] Incluye plan por cada submodulo.
- [x] Incluye cronograma semanal dia por dia.
- [x] Incluye DoD verificable por area.
- [x] Incluye gates y evidencia obligatoria.
- [x] Incluye score actual y meta de salida.
- [x] Incluye dependencias y ruta critica.

## 14. Adaptacion Executor-Ready (Claude Code / GitHub Copilot)

Objetivo de esta seccion: convertir el plan en instrucciones operativas de baja ambiguedad para agentes ejecutores.

### 14.1 Protocolo obligatorio por tarea

Cada tarea (T01..T10) debe seguir exactamente este ciclo:

1. `Context Load`: leer fuentes canónicas del plan y estado actual.
2. `Implement`: aplicar cambios mínimos necesarios para cumplir DoD.
3. `Verify`: ejecutar comandos de verificación definidos para la tarea.
4. `Evidence`: escribir evidencia en `docs/closure/` y/o `test-reports/`.
5. `Sync Docs`: actualizar `docs/ESTADO_ACTUAL.md` y `docs/DECISION_LOG.md` si aplica.

### 14.2 Contrato de salida por tarea

Formato exigido para cierre de cada tarea:

- Estado: `PASS | PARCIAL | BLOCKED | FAIL`
- Archivos tocados
- Comandos ejecutados + resultado
- Evidencia creada (ruta exacta)
- Riesgo residual (si existe)
- Siguiente paso inmediato

### 14.3 Guardrails específicos para ejecutores

- No exponer secretos/JWTs (solo nombres).
- No usar comandos destructivos de git.
- `api-minimarket` debe permanecer `verify_jwt=false` en redeploy (`--no-verify-jwt`).
- Si hay dependencia externa (owner/proveedor), marcar `BLOCKED` y continuar con la siguiente tarea.
- No cerrar una tarea sin evidencia verificable.

## 15. Subplanes Modulares Adaptados (Paquetes Ejecutables)

Cada submódulo se transforma en un paquete con entradas, salidas y verificación para Claude/Copilot.

## 15.1 M1 Arquitectura

| Submódulo | Entradas obligatorias | Entregable técnico | Verificación mínima | Evidencia mínima |
|---|---|---|---|---|
| M1.S1 | `supabase/functions/deno.json`, `minimarket-system/package.json`, `package.json` | Estrategia única de versionado SDK | Diff de versiones y política final | `docs/closure/EVIDENCIA_M1_S1_*.md` |
| M1.S2 | `minimarket-system/src/lib/roles.ts` + usos | Decisión sobre `extractUserRole` (eliminar o justificar) | búsqueda de usos productivos | `docs/closure/EVIDENCIA_M1_S2_*.md` |
| M1.S3 | scripts/gates CI local | Matriz de checks por superficie | ejecución de gates base | `test-reports/quality-gates_*.log` |

## 15.2 M2 Frontend

| Submódulo | Entradas obligatorias | Entregable técnico | Verificación mínima | Evidencia mínima |
|---|---|---|---|---|
| M2.S1 | `minimarket-system/src/App.tsx` | Ruta catch-all `*` y vista controlada | test de navegación inválida | `docs/closure/EVIDENCIA_M2_S1_*.md` |
| M2.S2 | 5 páginas sin test | Tests smoke nuevos (5 páginas) | `pnpm -C minimarket-system test:components` | junit + evidencia en `docs/closure/` |
| M2.S3 | `ErrorMessage`, `Skeleton`, empty states | Checklist UX por página | checklist QA + pruebas de render | `docs/closure/EVIDENCIA_M2_S3_*.md` |

## 15.3 M3 Backend

| Submódulo | Entradas obligatorias | Entregable técnico | Verificación mínima | Evidencia mínima |
|---|---|---|---|---|
| M3.S1 | funciones `cron-*` críticas | Guard interno homogéneo en entrada | pruebas 401/200 por endpoint | `docs/closure/EVIDENCIA_M3_S1_*.md` |
| M3.S2 | `cron-notifications/index.ts` | Redacción/mascarado PII en logs/persistencia | grep campos sensibles + tests | `docs/closure/EVIDENCIA_M3_S2_*.md` |
| M3.S3 | `deploy.sh`, reglas auth | Contrato operativo de deploy preservado | dry-run deploy + validación flags | `docs/closure/EVIDENCIA_M3_S3_*.md` |

## 15.4 M4 Base de Datos

| Submódulo | Entradas obligatorias | Entregable técnico | Verificación mínima | Evidencia mínima |
|---|---|---|---|---|
| M4.S1 | scripts `scripts/rls_*` | Revalidación RLS periódica | ejecución scripts en PASS | `docs/closure/EVIDENCIA_M4_S1_*.md` |
| M4.S2 | migraciones + runbooks | Runbook único cron/MV | checklist operativo | `docs/closure/EVIDENCIA_M4_S2_*.md` |
| M4.S3 | `docs/ESQUEMA_BASE_DATOS_ACTUAL.md` + migraciones | Esquema sin drift crítico | diff esquema/migraciones | `docs/closure/EVIDENCIA_M4_S3_*.md` |

## 15.5 M5 Testing

| Submódulo | Entradas obligatorias | Entregable técnico | Verificación mínima | Evidencia mínima |
|---|---|---|---|---|
| M5.S1 | `tests/security/` | Security suite no-tautológica | ejecución security suite | junit security + log |
| M5.S2 | `vitest.config.ts`, `.github/workflows/ci.yml` | Coverage governance consistente | run cobertura + revisión CI | `docs/closure/EVIDENCIA_M5_S2_*.md` |
| M5.S3 | `tests/integration`, `tests/e2e` | Integración real ampliada en rutas críticas | run integration/e2e smoke | reportes + evidencia |

## 15.6 M6 Seguridad

| Submódulo | Entradas obligatorias | Entregable técnico | Verificación mínima | Evidencia mínima |
|---|---|---|---|---|
| M6.S1 | `supabase/config.toml` + decisiones | Matriz target auth preprod | checklist auth aprobado | `docs/closure/EVIDENCIA_M6_S1_*.md` |
| M6.S2 | planes Sentry/SendGrid/rotación | Cierre de pendientes owner | validación funcional final | `docs/closure/EVIDENCIA_M6_S2_*.md` |
| M6.S3 | D-051/D-055 | decisión final leaked password protection | verificación de estado final | `docs/DECISION_LOG.md` |

## 15.7 M7 Documentación

| Submódulo | Entradas obligatorias | Entregable técnico | Verificación mínima | Evidencia mínima |
|---|---|---|---|---|
| M7.S1 | `docs/ESTADO_ACTUAL.md` | Estado canónico sincronizado | freshness + coherencia | actualización explícita en doc |
| M7.S2 | API docs + esquema docs | Cero doc fantasma crítico | chequeo APISync/DocuGuard | `docs/closure/EVIDENCIA_M7_S2_*.md` |
| M7.S3 | `docs/closure/` | Índice de evidencias actualizado | links y archivos válidos | `docs/closure/README_CANONICO.md` |

## 15.8 M8 DevOps/CI

| Submódulo | Entradas obligatorias | Entregable técnico | Verificación mínima | Evidencia mínima |
|---|---|---|---|---|
| M8.S1 | `deploy.sh` | allowlist branch + fail-fast | dry-run ramas válidas/inválidas | `docs/closure/EVIDENCIA_M8_S1_*.md` |
| M8.S2 | `.husky/pre-commit` | hook integral frontend+backend | ejecución local de hook | `docs/closure/EVIDENCIA_M8_S2_*.md` |
| M8.S3 | scripts de perf | baseline comparativo actualizado | run perf baseline | `docs/closure/PERF_BASELINE_*.md` |

## 16. Modo de Ejecucion Recomendado para Agentes

### 16.1 Secuencia óptima (Claude/Copilot)

- Fase 1 (bloqueo de riesgo): `T01 -> T02 -> T03 -> T04`
- Fase 2 (robustez funcional): `T05 -> T06 -> T07 -> T08`
- Fase 3 (dependencias externas + cierre): `T09 -> T10`

### 16.2 Paralelización segura

Se puede paralelizar sin conflicto:

- `T06` con `T05`
- `T07` con `T08`
- `M4.S2` con `M1.S2` (si no tocan mismas rutas)

No paralelizar:

- `T02` y `T03` (ambas alteran estrategia de calidad/pruebas).
- `T09` antes de terminar `T01-T04` (evita cerrar owner con base inestable).

### 16.3 Checkpoint de control cada 2 tareas

Checkpoint obligatorio:

1. Recalcular estado `PASS/PARCIAL/BLOCKED`.
2. Actualizar `docs/ESTADO_ACTUAL.md`.
3. Publicar evidencia de checkpoint en `docs/closure/`.
4. Verificar que el score objetivo sigue alcanzable.
