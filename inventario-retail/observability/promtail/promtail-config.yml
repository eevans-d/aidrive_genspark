# Promtail Configuration for Mini Market System
# Collects logs from all containers and ships to Loki

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

# Send logs to Loki
clients:
  - url: http://loki:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s

# Positions file (tracks what has been read)
positions:
  filename: /tmp/positions.yaml

# Scrape configurations
scrape_configs:
  # ============================================
  # 1. DOCKER CONTAINERS (all services)
  # ============================================
  - job_name: containers
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["logging=promtail"]
    
    relabel_configs:
      # Only scrape containers with label logging=promtail
      - source_labels: ['__meta_docker_container_label_logging']
        action: keep
        regex: promtail
      
      # Container name
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: container
      
      # Service name from compose
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: service
      
      # Project name
      - source_labels: ['__meta_docker_container_label_com_docker_compose_project']
        target_label: project
      
      # Environment
      - source_labels: ['__meta_docker_container_label_environment']
        target_label: environment
        replacement: 'production'
      
      # Log path
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: stream
    
    # Pipeline stages for log processing
    pipeline_stages:
      # Parse JSON logs (FastAPI default)
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            request_id: request_id
            service: service
            method: method
            path: path
            status_code: status_code
            duration_ms: duration_ms
      
      # Extract timestamp
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      # Set log level as label
      - labels:
          level:
          service:
          request_id:
      
      # Add metrics
      - metrics:
          log_lines_total:
            type: Counter
            description: "Total number of log lines"
            source: message
            config:
              action: inc
          
          log_bytes_total:
            type: Counter
            description: "Total bytes of log data"
            source: message
            config:
              action: add
              match_all: true
      
      # Drop debug logs in production (optional)
      # - match:
      #     selector: '{level="DEBUG"}'
      #     action: drop

  # ============================================
  # 2. SYSTEM LOGS (syslog)
  # ============================================
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: syslog
          __path__: /var/log/syslog
    
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\S+\s+\d+\s+\d+:\d+:\d+)\s+(?P<hostname>\S+)\s+(?P<app>\S+)(\[(?P<pid>\d+)\])?: (?P<message>.*)$'
      
      - labels:
          hostname:
          app:
      
      - timestamp:
          source: timestamp
          format: "Jan _2 15:04:05"

  # ============================================
  # 3. NGINX ACCESS LOGS
  # ============================================
  - job_name: nginx
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          __path__: /var/log/nginx/access.log
    
    pipeline_stages:
      # Parse nginx combined log format
      - regex:
          expression: '^(?P<remote_addr>\S+) - (?P<remote_user>\S+) \[(?P<time_local>[^\]]+)\] "(?P<method>\S+) (?P<path>\S+) (?P<protocol>\S+)" (?P<status>\d+) (?P<body_bytes_sent>\d+) "(?P<http_referer>[^"]*)" "(?P<http_user_agent>[^"]*)"'
      
      - labels:
          method:
          status:
      
      - timestamp:
          source: time_local
          format: "02/Jan/2006:15:04:05 -0700"
      
      # Extract metrics
      - metrics:
          nginx_requests_total:
            type: Counter
            description: "Total nginx requests"
            config:
              action: inc
