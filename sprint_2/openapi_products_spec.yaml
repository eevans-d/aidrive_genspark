# Especificación OpenAPI 3.1 para el Sistema Mini Market

## Productos API Specification

openapi: 3.1.0
info:
  title: Mini Market Products Management API
  description: |
    API completa para gestión de productos del sistema Mini Market.
    
    Funcionalidades:
    - Gestión completa de productos con atributos GS1
    - Categorización jerárquica de productos  
    - Manejo de proveedores y márgenes de ganancia
    - Búsqueda avanzada con filtros múltiples
    - Paginación optimizada para grandes volúmenes
    
    **Autenticación**: JWT Bearer Token requerido
  version: 1.0.0
  contact:
    name: Mini Market Development Team
    email: dev@minimarket.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.minimarket.com/v1
    description: Servidor de Producción
  - url: https://staging-api.minimarket.com/v1
    description: Servidor de Staging
  - url: http://localhost:3000/v1
    description: Servidor de Desarrollo

paths:
  /products:
    get:
      tags:
        - Productos
      summary: Obtener lista de productos
      description: |
        Retorna una lista paginada de productos con filtros opcionales.
        
        **Permisos requeridos**: `products:read`
      operationId: getProducts
      parameters:
        - name: limit
          in: query
          description: Número máximo de productos a retornar
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Número de productos a omitir
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: category_id
          in: query
          description: Filtrar por categoría específica
          schema:
            type: integer
        - name: active
          in: query
          description: Filtrar por estado activo
          schema:
            type: boolean
        - name: search
          in: query
          description: Buscar en nombre, descripción o SKU
          schema:
            type: string
        - name: sort
          in: query
          description: Campo de ordenamiento
          schema:
            type: string
            enum: [name, price, created_at, updated_at, stock_quantity]
            default: name
        - name: order
          in: query
          description: Dirección de ordenamiento
          schema:
            type: string
            enum: [asc, desc]
            default: asc
      responses:
        '200':
          description: Lista de productos obtenida exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Product'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
                  filters:
                    type: object
                    properties:
                      applied:
                        type: array
                        items:
                          type: object
                          properties:
                            field:
                              type: string
                            value:
                              type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Productos
      summary: Crear nuevo producto
      description: |
        Crea un nuevo producto en el catálogo del Mini Market.
        
        **Permisos requeridos**: `products:create`
        
        **Validaciones**:
        - SKU debe ser único
        - GTIN debe ser válido si se proporciona
        - Categoría debe existir
        - Precio debe ser mayor que 0
      operationId: createProduct
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sku
                - name
                - category_id
                - supplier_id
              properties:
                sku:
                  type: string
                  pattern: '^[A-Za-z0-9_-]+$'
                  example: "MP001"
                  description: Código único del producto
                gtin:
                  type: string
                  pattern: '^\d{8,14}$'
                  description: Código de barras GTIN
                name:
                  type: string
                  minLength: 2
                  maxLength: 255
                  example: "Leche Entera 1L"
                description:
                  type: string
                  maxLength: 1000
                  example: "Leche entera descremada de alta calidad"
                category_id:
                  type: integer
                  example: 1
                supplier_id:
                  type: integer
                  example: 1
                brand:
                  type: string
                  maxLength: 100
                  example: "La Serenísima"
                price:
                  type: number
                  minimum: 0
                  example: 125.50
                cost_price:
                  type: number
                  minimum: 0
                  example: 85.00
                currency:
                  type: string
                  default: "ARS"
                  example: "ARS"
                unit_measure:
                  type: string
                  enum: [unit, liter, kilogram, gram, meter, centimeter, square_meter, cubic_meter]
                  default: "unit"
                  example: "unit"
                dimensions:
                  type: object
                  properties:
                    length:
                      type: number
                    width:
                      type: number
                    height:
                      type: number
                    weight:
                      type: number
                  example:
                    length: 10
                    width: 10
                    height: 15
                    weight: 1.5
                attributes:
                  type: object
                  additionalProperties: true
                  example:
                    content: "3.5%"
                    packaging: "Tetra Pack"
                    expiration_days: 30
      responses:
        '201':
          description: Producto creado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Product'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

  /products/{product_id}:
    get:
      tags:
        - Productos
      summary: Obtener producto específico
      description: |
        Retorna los detalles completos de un producto específico.
        
        **Permisos requeridos**: `products:read`
      operationId: getProduct
      parameters:
        - name: product_id
          in: path
          description: ID único del producto
          required: true
          schema:
            type: integer
          example: 123
      responses:
        '200':
          description: Detalles del producto
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/ProductDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Productos
      summary: Actualizar producto completo
      description: |
        Actualiza completamente los datos de un producto.
        
        **Permisos requeridos**: `products:update`
        
        **Validaciones**: Todos los campos requeridos deben estar presentes
      operationId: updateProduct
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: integer
          example: 123
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/ProductCreate'
                - type: object
                  required:
                    - sku
                    - name
                    - category_id
                    - supplier_id
      responses:
        '200':
          description: Producto actualizado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Product'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

    patch:
      tags:
        - Productos
      summary: Actualizar producto parcialmente
      description: |
        Actualiza parcialmente los datos de un producto.
        
        **Permisos requeridos**: `products:update`
      operationId: partialUpdateProduct
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: "Leche Entera Enriquecida 1L"
                price:
                  type: number
                  minimum: 0
                  example: 135.50
                active:
                  type: boolean
                  example: true
                attributes:
                  type: object
                  example:
                    content: "3.8%"
                    vitamins: "A, D"
      responses:
        '200':
          description: Producto actualizado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Product'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

    delete:
      tags:
        - Productos
      summary: Eliminar producto
      description: |
        Elimina permanentemente un producto del sistema.
        
        **Permisos requeridos**: `products:delete`
        
        **Nota**: Solo productos sin inventario o ventas pueden ser eliminados
      operationId: deleteProduct
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Producto eliminado exitosamente
        '400':
          description: No se puede eliminar producto con inventario o ventas
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT obtenido del endpoint de autenticación

  schemas:
    Product:
      type: object
      properties:
        id:
          type: integer
          example: 123
        sku:
          type: string
          example: "MP001"
        gtin:
          type: string
          nullable: true
          example: "7790001234567"
        name:
          type: string
          example: "Leche Entera 1L"
        description:
          type: string
          nullable: true
        category_id:
          type: integer
          example: 1
        category_name:
          type: string
          example: "Lácteos"
        supplier_id:
          type: integer
          example: 1
        supplier_name:
          type: string
          example: "La Serenísima"
        brand:
          type: string
          nullable: true
          example: "La Serenísima"
        price:
          type: number
          format: float
          example: 125.50
        cost_price:
          type: number
          format: float
          nullable: true
          example: 85.00
        currency:
          type: string
          example: "ARS"
        unit_measure:
          type: string
          example: "unit"
        dimensions:
          type: object
          properties:
            length:
              type: number
              format: float
            width:
              type: number
              format: float
            height:
              type: number
              format: float
            weight:
              type: number
              format: float
          nullable: true
        attributes:
          type: object
          additionalProperties: true
          nullable: true
        active:
          type: boolean
          example: true
        stock_quantity:
          type: integer
          example: 50
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ProductDetail:
      allOf:
        - $ref: '#/components/schemas/Product'
        - type: object
          properties:
            history:
              type: object
              properties:
                last_price_change:
                  type: string
                  format: date-time
                last_stock_change:
                  type: string
                  format: date-time
            supplier_details:
              type: object
              properties:
                contact_person:
                  type: string
                email:
                  type: string
                phone:
                  type: string
                address:
                  type: string
            category_details:
              type: object
              properties:
                margin_min:
                  type: number
                  format: float
                margin_max:
                  type: number
                  format: float
                markup_default:
                  type: number
                  format: float

    ProductCreate:
      allOf:
        - $ref: '#/components/schemas/Product'
        - type: object
          properties:
            id:
              readOnly: true
            created_at:
              readOnly: true
            updated_at:
              readOnly: true
            stock_quantity:
              readOnly: true

    Pagination:
      type: object
      properties:
        current_page:
          type: integer
          example: 1
        per_page:
          type: integer
          example: 20
        total:
          type: integer
          example: 150
        total_pages:
          type: integer
          example: 8
        has_next_page:
          type: boolean
          example: true
        has_prev_page:
          type: boolean
          example: false
        next_page_url:
          type: string
          nullable: true
          example: "/api/v1/products?page=2"
        prev_page_url:
          type: string
          nullable: true

    Error:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: "VALIDATION_ERROR"
            message:
              type: string
              example: "Los datos proporcionados no son válidos"
            details:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                    example: "sku"
                  message:
                    type: string
                    example: "El SKU ya existe en el sistema"
                  code:
                    type: string
                    example: "DUPLICATE_SKU"
        metadata:
          type: object
          properties:
            timestamp:
              type: string
              format: date-time
            request_id:
              type: string
              example: "req_123456789"
            trace_id:
              type: string
              example: "trace_987654321"

  responses:
    BadRequest:
      description: Solicitud inválida
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: No autenticado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Forbidden:
      description: No autorizado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Producto no encontrado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Conflict:
      description: Conflicto de datos
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    UnprocessableEntity:
      description: Entidad no procesable
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    RateLimitExceeded:
      description: Límite de tasa excedido
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
      headers:
        X-Rate-Limit-Limit:
          description: Número máximo de solicitudes permitidas en la ventana actual
          schema:
            type: integer
        X-Rate-Limit-Remaining:
          description: Número de solicitudes restantes en la ventana actual
          schema:
            type: integer
        X-Rate-Limit-Reset:
          description: Tiempo en segundos hasta que el límite se restablezca
          schema:
            type: integer
        Retry-After:
          description: Tiempo en segundos para esperar antes de reintentar
          schema:
            type: integer

    InternalServerError:
      description: Error interno del servidor
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

tags:
  - name: Productos
    description: API para gestión de productos del Mini Market
    externalDocs:
      description: Documentación completa de productos
      url: https://docs.minimarket.com/products

security:
  - bearerAuth: []

# Rate Limiting Configuration
x-rate-limits:
  authenticated:
    requests_per_minute: 100
    burst_limit: 120
  public:
    requests_per_minute: 20
    burst_limit: 25